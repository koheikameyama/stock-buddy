# Stock Buddy 仕様書 v2.0

## 1. サービス概要

**サービス名**：Stock Buddy
**新キャッチコピー**：あなた専属のAI投資コーチ

Stock Buddyは、投資初心者のための**AI投資コーチ**。
投資の知識がなくても、AIコーチが寄り添いながら、
一歩ずつ投資を学び、成長できる体験を提供します。

**従来のポジショニング（変更前）:**
- ❌ AIが判断を出す「投資支援ツール」
- ❌ 株式シミュレーター

**新しいポジショニング（v2.0）:**
- ✅ あなた専属の「AI投資コーチ」
- ✅ 安心して投資を始められる「相棒」
- ✅ 投資を通じて成長する「学習プラットフォーム」

---

## 2. コアコンセプト

### 2.1 なぜ「コーチ」なのか

**既存ツールの問題:**
- 証券会社のツール → 機能は豊富だが、初心者には難しい
- シミュレーター → 何を買えばいいか分からない
- 投資情報サイト → 情報が多すぎて不安

**Stock Buddyが提供する体験:**
```
🏃 パーソナルトレーナーに例えると...

一般的なジム = 証券会社のツール
- 器具はある
- でも使い方が分からない
- 自分に合ったメニューも分からない

パーソナルトレーナー = Stock Buddy
- あなたに合ったメニューを提案
- 正しいフォームを教える
- 励まして、成長を見守る
- 結果が出ると一緒に喜ぶ
```

### 2.2 3つの柱

1. **安心感** - 一人じゃない、コーチがいる
2. **学び** - 自然と投資の考え方が身につく
3. **成長実感** - レベルアップ、バッジ、実績

---

## 3. ターゲットユーザー

### メインターゲット（初期）
- **年齢**: 20-40代
- **投資経験**: 未経験〜初心者
- **投資予算**: 5万円〜50万円
- **心理**: 「投資に興味はあるけど、怖い・分からない」

**ペルソナ例:**
```
田中さん（28歳・会社員）
「貯金が100万円あるけど、投資って怖い。
 でも銀行に置いておくだけじゃもったいない気もする。
 何から始めればいいか分からない...」

→ Stock Buddyで仮想投資からスタート
→ 1ヶ月後、+2.8%の成績で自信がつく
→ 実際に証券口座を開設して投資デビュー
```

### 非ターゲット（当面は対象外）
- 投資経験者・上級者
- デイトレーダー
- 大口投資家（500万円以上）

---

## 4. ユーザージャーニー

### 4.1 フェーズ1: 出会い（初回訪問）

**ランディングページ**
```
ヘッドライン:
「投資、始めたいけど怖い？
 AIコーチが一緒に考えます」

副見出し:
「3つの質問に答えるだけで、
 あなたに合った投資プランを提案」

CTA: [無料で始める（3分）]

実績表示:
「先月の推奨プラン平均リターン: +2.8%」
「1,234人が投資デビュー」
```

**ユーザーの不安に対処:**
- 「お金は使いません」（仮想投資）
- 「無料で試せます」
- 「いつでも辞められます」

### 4.2 フェーズ2: 信頼構築（オンボーディング）

**会話形式の質問（3ステップ）**

```
ステップ1: 予算
「まずは少額から始めましょう。
 いくらから始めますか？」

[5万円] [10万円] [30万円] [カスタム]

↓

ステップ2: 性格診断
「投資にリスクはつきものです。
 あなたはどのタイプ？」

[安定志向] - 損したくない、ゆっくり増やしたい
[バランス型] - ほどほどのリスクとリターン
[成長志向] - リスク取れる、大きく増やしたい

↓

ステップ3: 期間
「どのくらいの期間で考えていますか？」

[短期（3ヶ月）] [中期（1年）] [長期（3年以上）]

↓

「プランを作成しています...
 あなたの投資の旅が始まります」
```

**トーンの変更:**
- ❌ 事務的「投資予算を選択してください」
- ✅ 親しみやすい「まずは少額から始めましょう」

### 4.3 フェーズ3: プラン提示

**コーチからのメッセージ形式**

```
┌─────────────────────────────────┐
│ 〇〇さん、お待たせしました！      │
│                                  │
│ あなたの目標と性格を考えて、     │
│ 3つのプランを用意しました。      │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│ 【おすすめ】バランスプラン        │
│ まずはこれから始めてみませんか？  │
│                                  │
│ 理由:                            │
│ ✓ 予算50万円で無理なく分散投資   │
│ ✓ 大企業中心で安心               │
│ ✓ 年10-15%のリターンを狙えます   │
│                                  │
│ [このプランで始める]             │
└─────────────────────────────────┘

他のプラン:
保守的プラン（安定重視）
積極的プラン（成長重視）
```

**従来との違い:**
- ❌ 表形式で無機質に3プラン並べる
- ✅ コーチが「おすすめ」を明示、理由を説明

### 4.4 フェーズ4: スタート

**「投資の旅」開始画面**

```
┌─────────────────────────────────┐
│ 🎉 おめでとうございます！         │
│                                  │
│ 投資の第一歩を踏み出しましたね。  │
└─────────────────────────────────┘

【あなたの投資プラン】
┌─────────────────────────────────┐
│ トヨタ自動車    200株  334,700円 │
│ ソニーグループ  100株  203,153円 │
│ 三菱UFJ        300株   42,000円 │
│                                  │
│ 合計: 579,853円                 │
└─────────────────────────────────┘

💡 これは「仮想投資」です
実際のお金は使っていません。

まずは練習として、
このプランを追いかけてみましょう。

実際に買う準備ができたら、
証券口座の開設をサポートします。

[毎日チェックする] [投資の基礎を学ぶ]
```

**重要な変更:**
- ✅ 「仮想投資」であることを明確に
- ✅ 安心感を与える
- ✅ 次のアクションを提示

### 4.5 フェーズ5: 日常利用（コーチング）

**ダッシュボード（メイン画面）**

```
┌─────────────────────────────────┐
│ おはようございます、〇〇さん！    │
│ 今日も一緒に投資を見守りましょう │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│ 📊 今日の状況                    │
│                                  │
│ あなたの投資プラン               │
│ 評価額: 595,320円               │
│ 損益: +15,467円 (+2.7%) ⬆️      │
│                                  │
│ 💬 コーチのコメント:             │
│ 「順調です！日経平均(+1.2%)より  │
│  良いパフォーマンスですよ」      │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│ 📈 あなたの成長                  │
│ [グラフ: 1ヶ月間の推移]          │
│                                  │
│ 投資開始: 30日前                 │
│ 投資レベル: 2 (初心者コース)     │
│ 獲得バッジ: 🏅 1ヶ月継続         │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│ 📰 あなたに関連するニュース       │
│ トヨタが新型EV発表               │
│ → あなたの保有銘柄に関連         │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│ 💡 今日の投資ヒント              │
│ 「短期の値動きに一喜一憂しないのが│
│  長期投資のコツです」            │
└─────────────────────────────────┘

[銘柄の詳細を見る]
[AIコーチに相談する]
[実際に投資を始める]
```

**デザイン原則:**
- ✅ 親しみやすいトーン（「おはようございます」）
- ✅ 励まし・肯定的なフィードバック
- ✅ 成長の可視化（レベル、バッジ）
- ✅ 情報は最小限（見やすさ優先）

### 4.6 フェーズ6: 週次振り返り

**毎週日曜夜に通知**

```
件名: 【Stock Buddy】今週の振り返り

〇〇さん、今週もお疲れ様でした！

【今週の成績】
あなた:   +1,200円 (+0.24%) ⬆️
みんな:   +0.18%

✨ みんなより良い成績です！

【今週のハイライト】
✅ ソニーが+3.2%上昇
   → 新製品発表が好材料に
⚠️ 三菱UFJが-0.5%下落
   → でも心配いりません

💬 コーチのアドバイス:
銀行株は短期的に変動しやすいですが、
長期的には安定しています。
慌てて売らないでくださいね。

【来週の見通し】
決算発表シーズンに入ります。
あなたの保有銘柄では、
トヨタが来週木曜に決算予定。

[詳しく見る]
```

### 4.7 フェーズ7: 実投資への移行

**条件達成時（例: 1ヶ月 & プラス成績）**

```
┌─────────────────────────────────┐
│ 🎉 おめでとうございます！         │
│                                  │
│ 1ヶ月間、しっかり投資を学びました │
└─────────────────────────────────┘

【あなたの成績】
仮想投資: 579,853円 → 595,320円
損益: +15,467円 (+2.7%)

実際の投資に挑戦する準備ができました。

【次のステップ】
1. 証券口座を開設する
2. このプランで実際に投資を始める
3. 引き続きAIコーチがサポートします

💰 今なら証券口座開設で
    5,000円キャッシュバック

[証券口座を開設する]
[もう少し練習する]
```

---

## 5. 機能一覧

### 5.1 コア機能

#### 1. オンボーディング（初回診断）✅ 実装済
- 2つの質問で投資スタイル診断（予算・期間）
- シンプルなフォームUI
- 3分で完了
- **月次制限**: AI提案は月3回まで（RecommendationLogテーブルで管理）
- 制限超過時: 429エラーでリセット日を通知

#### 2. ポートフォリオ自動生成 ✅ 実装済
- 予算・期間に基づくAI提案
- 投資期間に応じた銘柄数の自動決定
  - 長期（3年以上）: 4-5銘柄
  - 中期（1-3年）: 3-4銘柄
  - 短期（1年未満）: 2-3銘柄
- 初心者向けスコア（beginnerScore）で銘柄選定
- セクター分散を考慮

#### 3. 今持ってる銘柄（ポートフォリオ）✅ 実装済
- **最大5銘柄まで**登録可能（MAX_PORTFOLIO_STOCKS = 5）
- 実際の投資とシミュレーションの両対応
- 平均取得単価の自動計算
- トランザクション記録（Transaction テーブル）
- 専用モジュール（lib/portfolio.ts）で制限管理

#### 4. 気になる銘柄（ウォッチリスト）✅ 実装済
- **最大5銘柄まで**登録可能（MAX_WATCHLIST_STOCKS = 5）
- 推奨価格・推奨数量の保存
- 「今日の注目銘柄」から追加可能
- 専用モジュール（lib/watchlist.ts）で制限管理

#### 5. 今日の注目銘柄 ✅ 実装済
- **全ユーザー共通**で毎日3銘柄を提案
- GitHub Actions（daily-featured-stocks.yml）で自動生成
  - 実行時刻: 毎日JST 5:00 (UTC 20:00)
- 選定ロジック:
  - 初心者向けスコア70以上
  - セクター分散を考慮
  - 最新の株価データがある銘柄のみ
- DailyFeaturedStock テーブルで管理
- ダッシュボードに表示、直接ウォッチリストに追加可能

#### 6. ダッシュボード（毎日の画面）✅ 実装済
- 今日の注目銘柄（3銘柄）
- ポートフォリオの状況
- ウォッチリストの状況
- コーチメッセージ（CoachMessage テーブル）
- 株価推移グラフ

#### 7. 評価額の日次記録 ✅ 実装済
- 毎日の評価額をDB保存（PortfolioSnapshot テーブル）
- GitHub Actions（daily-stock-fetch.yml）で自動実行
  - 実行時刻: 平日JST 18:00 (UTC 09:00)
- グラフで推移を表示
- 損益計算（金額・率）

#### 8. 日次分析 ✅ 実装済
- GitHub Actions（daily-analysis.yml）で自動実行
  - 実行時刻: 毎日JST 6:00 (UTC 21:00)
- ウォッチリスト銘柄の分析
- ポートフォリオ銘柄の分析
- コーチメッセージの生成
- プッシュ通知の送信

#### 9. 週次レポート ✅ 実装済
- GitHub Actions（daily-report.yml）で自動生成
  - 実行時刻: 毎日JST 9:00 (UTC 0:00)
- ポートフォリオの週次サマリー
- 損益の推移
- 今週のハイライト

#### 10. プッシュ通知 ✅ 実装済
- Web Push API を使用
- VAPID認証（遅延初期化）
- 購読管理（PushSubscription テーブル）
- ポートフォリオ保有ユーザーにのみ通知
- 410 Gone エラー時に自動購読削除

#### 11. マーケットニュース ✅ 実装済
- GitHub Actions（fetch-market-news.yml）で自動取得
  - 実行時刻: 毎日JST 9:00 (UTC 0:00)
- Tavily API + OpenAI API で要約
- MarketNews テーブルで管理

#### 12. 投資レベル・バッジシステム 🚧 部分実装
- UserProgress テーブル準備済み
- UIは未実装

#### 13. 証券口座開設誘導 📋 未実装
- 実績が出た後
- アフィリエイトリンク
- 開設ガイド

### 5.2 フェーズ別実装計画

**フェーズ1: MVP（1-2週間）**
- [x] オンボーディング（既存）
- [x] ポートフォリオ生成（既存）
- [ ] ダッシュボードのリデザイン
- [ ] トーン・文言の全面見直し
- [ ] 評価額の日次記録
- [ ] 「今日のメッセージ」機能

**フェーズ2: エンゲージメント強化（2-4週間）**
- [ ] 週次レポート自動生成
- [ ] 投資レベル・バッジシステム
- [ ] グラフ表示（推移の可視化）
- [ ] メール通知機能

**フェーズ3: 学習コンテンツ（1-2ヶ月）**
- [ ] 投資の基礎コース
- [ ] AIチャット相談
- [ ] クイズ・理解度チェック

**フェーズ4: 収益化（2-3ヶ月）**
- [ ] 証券口座開設フロー
- [ ] アフィリエイト統合
- [ ] プレミアム機能（将来）

---

## 6. データベース設計（追加）

### 6.1 新規テーブル

```prisma
// 仮想ポートフォリオの日次評価額
model PortfolioSnapshot {
  id                String   @id @default(cuid())
  portfolioId       String
  date              DateTime
  totalValue        Decimal  // 評価額
  totalCost         Decimal  // 投資額
  profitLoss        Decimal  // 損益
  profitLossPercent Decimal  // 損益率

  portfolio         Portfolio @relation(fields: [portfolioId], references: [id])

  @@index([portfolioId, date])
  @@unique([portfolioId, date])
}

// コーチからのメッセージ
model CoachMessage {
  id        String   @id @default(cuid())
  userId    String
  type      String   // "daily", "weekly", "milestone", "alert"
  title     String
  message   String   @db.Text
  sentiment String   // "positive", "neutral", "warning"
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([userId, read])
}

// ユーザーの投資レベル・進捗
model UserProgress {
  id              String    @id @default(cuid())
  userId          String    @unique
  level           Int       @default(1)
  experience      Int       @default(0)
  daysInvested    Int       @default(0)
  lastCheckIn     DateTime?
  currentStreak   Int       @default(0)  // 連続ログイン日数
  longestStreak   Int       @default(0)
  badges          String[]  // ["first_investment", "one_month", "positive_return"]
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            User      @relation(fields: [userId], references: [id])
}

// バッジ定義（マスターデータ）
model Badge {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String
  icon        String
  condition   String   @db.Text  // JSON形式の条件定義
  order       Int      @default(0)
  createdAt   DateTime @default(now())
}
```

---

## 7. トーン＆マナー

### 7.1 基本方針

**従来（ツール的）:**
- 「投資予算を選択してください」
- 「ポートフォリオを表示します」
- 「推奨銘柄」

**新方針（コーチ的）:**
- 「まずは少額から始めましょう」
- 「あなたの投資プランをお見せします」
- 「あなたにおすすめの銘柄」

### 7.2 具体例

| シーン | ❌ 従来 | ✅ 新 |
|--------|---------|-------|
| オンボーディング | 投資予算を選択 | いくらから始めますか？ |
| プラン提示 | 以下の3プランを提案します | あなたに合った3つのプランを用意しました |
| 損失時 | -5%です | 一時的に下がっていますが、長期では普通です |
| 利益時 | +5%です | 素晴らしい！順調ですね |
| 通知 | レポートが生成されました | 今週も一緒に振り返りましょう |

### 7.3 禁止表現

- ❌ 「必ず儲かる」「絶対」などの断定
- ❌ 「今すぐ買うべき」などの煽り
- ❌ 専門用語の説明なし使用
- ❌ 冷たい・事務的な表現

### 7.4 推奨表現

- ✅ 「一緒に」「見守る」「応援」
- ✅ 「おすすめ」「提案」「考えました」
- ✅ 励まし・肯定的フィードバック
- ✅ 親しみやすい敬語

---

## 8. 収益化戦略

### 8.1 基本方針

**短期（0-6ヶ月）: 信頼構築**
- 完全無料
- 実績を作る
- ユーザーを増やす

**中期（6-12ヶ月）: 収益化開始**
- 証券口座アフィリエイト
- プレミアム機能（月980円）

**長期（12ヶ月〜）: スケール**
- B2B展開（証券会社向け）
- データ販売（匿名化）
- 教育コンテンツ

### 8.2 アフィリエイトモデル

**証券口座開設への誘導**

```
タイミング:
- 仮想ポートフォリオが+10%到達
- 1ヶ月継続達成
- ユーザーが「始めたい」と思った時

メッセージ:
「素晴らしい成績です！
 実際に投資を始めてみませんか？

 おすすめの証券会社:
 ✓ 楽天証券（手数料最安級）
 ✓ SBI証券（取扱銘柄最多）
 ✓ 今なら口座開設で5,000円」

報酬:
1口座開設 = 5,000-10,000円
```

**目標:**
- 月100人開設 × 8,000円 = 80万円/月

### 8.3 プレミアムモデル（将来）

```
基本: 無料
- 1つのプラン
- 月1回の再提案
- 基本レポート

プレミアム: 980円/月
- 3つのプラン比較
- 週1回の再提案
- 詳細レポート
- AIチャット相談
- 損益グラフ
```

**目標:**
- 1,000ユーザーの5% = 50人
- 50人 × 980円 = 49,000円/月

### 8.4 収益試算（1年後）

```
ユーザー数: 1,000人（MAU）

アフィリエイト:
- 口座開設: 50人/月 × 8,000円 = 400,000円

プレミアム:
- 課金率5%: 50人 × 980円 = 49,000円

合計: 449,000円/月 = 約540万円/年
```

---

## 9. 成功指標（KPI）

### 9.1 信頼性の指標

- **仮想ポートフォリオの平均リターン**
  - 目標: 日経平均+2%以上
- **勝率**（プラス成績のユーザー割合）
  - 目標: 60%以上
- **最大ドローダウン**
  - 目標: -15%以内

### 9.2 エンゲージメント

- **DAU/MAU比率**
  - 目標: 30%以上（週2回以上ログイン）
- **継続率**
  - 1週間後: 70%
  - 1ヶ月後: 50%
  - 3ヶ月後: 30%
- **平均セッション時間**
  - 目標: 3分以上

### 9.3 収益

- **証券口座開設コンバージョン率**
  - 目標: 5%（100人中5人）
- **アフィリエイト収益**
  - 目標: 月40万円（1年後）
- **プレミアム課金率**
  - 目標: 5%

---

## 10. 競合との差別化

### 10.1 既存サービスとの比較

| サービス | Stock Buddy | 楽天証券シミュレーター | トレダビ |
|---------|------------|---------------------|---------|
| ポジショニング | AI投資コーチ | 取引練習ツール | 投資ゲーム |
| 銘柄選び | AIが提案 | 自分で選ぶ | 自分で選ぶ |
| 学習要素 | コーチング | なし | ランキング競争 |
| パーソナライズ | あり | なし | なし |
| トーン | 親しみやすい | 事務的 | ゲーム的 |

### 10.2 独自の強み

1. **超初心者特化**
   - 「何を買えばいいか分からない」を解決
   - 銘柄選定をAIが代行

2. **パーソナルコーチ体験**
   - 寄り添う・励ます・見守る
   - 投資アドバイザーの民主化（月980円 vs 数万円）

3. **成長の可視化**
   - レベル・バッジ・実績
   - ゲーミフィケーション

4. **実績の透明性**
   - すべての推奨の成績を公開
   - 「隠さない」が信頼を生む

---

## 11. 開発ロードマップ

### Phase 1: MVP（Week 1-2）
- [ ] ダッシュボードのリデザイン
- [ ] トーン・文言の全面見直し
- [ ] 評価額の日次記録
- [ ] 「今日のメッセージ」機能

### Phase 2: エンゲージメント（Week 3-6）
- [ ] 週次レポート自動生成
- [ ] 投資レベル・バッジシステム
- [ ] グラフ表示
- [ ] メール通知

### Phase 3: 学習（Month 2-3）
- [ ] 投資の基礎コース
- [ ] AIチャット相談
- [ ] クイズ機能

### Phase 4: 収益化（Month 3-4）
- [ ] 証券口座開設フロー
- [ ] アフィリエイト統合
- [ ] プレミアム機能

---

## 12. Stock Buddy が目指す姿

**投資を「怖いもの」から「日常の選択」に変える**

```
従来の投資ツール:
「道具を渡すから、自分で使いこなせ」

Stock Buddy:
「一緒にやろう。分からなければ教える。
 失敗しても大丈夫。また挑戦しよう」
```

ユーザーにとって、
- **判断に悩む時間**を減らし
- **理解が積み上がる時間**を増やし
- **投資を楽しめる瞬間**を作る

そんな存在になる。

---

## 13. 技術仕様

### 13.1 アーキテクチャ

**フロントエンド**
- Next.js 15.5.10 (App Router)
- React Server Components
- TypeScript
- Tailwind CSS

**バックエンド**
- Next.js API Routes
- NextAuth.js (Google OAuth認証)
- Prisma ORM
- PostgreSQL (Railway)

**外部API**
- OpenAI API (GPT-4による分析・提案)
- Rakuten Rapid API (株価データ取得)
- Tavily API (ニュース検索)
- Web Push API (プッシュ通知)

**自動化**
- GitHub Actions (5つのワークフロー)
- Python スクリプト (データ処理)
- TypeScript スクリプト (分析・レポート生成)

### 13.2 GitHub Actions ワークフロー

#### 1. CI (ci.yml)
- **トリガー**: main/develop ブランチへのpush・PR
- **除外パス**: `**.md`, `scripts/**`, `.github/workflows/**` (ci.yml自体は除く), `docs/**`
- **実行内容**:
  - Lint (ESLint)
  - Type Check (TypeScript)
  - Build (Next.js)
- **通知**: Slack (成功/失敗)

#### 2. 株価データ取得 (daily-stock-fetch.yml)
- **実行時刻**: 平日 JST 18:00 (UTC 09:00)
- **実行内容**:
  1. Python: 株価データ取得 (fetch_stocks.py)
  2. TypeScript: 銘柄スコア計算 (calculate-stock-scores.ts)
  3. TypeScript: ポートフォリオスナップショット記録 (record-portfolio-snapshots.ts)
  4. TypeScript: コーチメッセージ生成 (generate-coach-messages-direct.ts)
- **通知**: Slack

#### 3. マーケットニュース取得 (fetch-market-news.yml)
- **実行時刻**: 毎日 JST 9:00 (UTC 0:00)
- **実行内容**: TypeScript: ニュース取得・要約 (fetch-market-news.ts)
- **通知**: Slack

#### 4. 今日の注目銘柄生成 (daily-featured-stocks.yml)
- **実行時刻**: 毎日 JST 5:00 (UTC 20:00)
- **実行内容**: Python: 注目銘柄選定 (generate_featured_stocks.py)
- **通知**: Slack

#### 5. 日次分析 (daily-analysis.yml)
- **実行時刻**: 毎日 JST 6:00 (UTC 21:00)
- **実行内容**: Python: 分析API呼び出し (generate_daily_analysis.py)
  - ウォッチリスト銘柄分析
  - ポートフォリオ銘柄分析
  - コーチメッセージ生成
  - プッシュ通知送信
- **通知**: Slack

#### 6. 週次レポート生成 (daily-report.yml)
- **実行時刻**: 毎日 JST 9:00 (UTC 0:00)
- **実行内容**: Python: レポート生成API呼び出し (generate_daily_report.py)
- **通知**: Slack

### 13.3 データベーススキーマ（主要テーブル）

**Stock** - 銘柄マスタ
- tickerCode, name, sector, beginnerScore など

**StockPrice** - 株価データ
- 日次の株価（open, close, high, low, volume）

**Portfolio** - ポートフォリオ
- userId, budget, isSimulation

**PortfolioStock** - ポートフォリオ銘柄
- portfolioId, stockId, quantity, averagePrice
- **最大5銘柄制限**

**Watchlist** - ウォッチリスト
- userId, stockId, recommendedPrice, recommendedQty
- **最大5銘柄制限**

**DailyFeaturedStock** - 今日の注目銘柄
- date, stockId, position (1-3), reason, score

**Transaction** - 取引履歴
- portfolioId, stockId, type, quantity, price

**PortfolioSnapshot** - ポートフォリオスナップショット
- 日次の評価額記録

**CoachMessage** - コーチメッセージ
- userId, type, title, message, sentiment

**RecommendationLog** - AI提案ログ
- userId, createdAt
- **月次制限管理用**（月3回まで）

**MarketNews** - マーケットニュース
- title, summary, publishedAt

**PushSubscription** - プッシュ通知購読
- userId, endpoint, p256dh, auth

**UserProgress** - ユーザー進捗
- level, experience, badges など（部分実装）

### 13.4 主要ライブラリ・モジュール

**lib/portfolio.ts**
- `addStockToPortfolio()` - 銘柄追加（5銘柄制限チェック）
- `MAX_PORTFOLIO_STOCKS = 5`

**lib/watchlist.ts**
- `addStockToWatchlist()` - ウォッチリスト追加（5銘柄制限チェック）
- `addMultipleStocksToWatchlist()` - 複数銘柄一括追加
- `MAX_WATCHLIST_STOCKS = 5`

**lib/recommendation-limit.ts**
- `canRequestRecommendation()` - 月次制限チェック
- `getMonthlyRecommendationCount()` - 今月の使用回数取得
- `MAX_RECOMMENDATIONS_PER_MONTH = 3`

**lib/technical-indicators.ts**
- テクニカル指標計算（SMA, RSI, Bollinger Bandsなど）

### 13.5 デプロイメント

**ホスティング**: Railway
- 自動デプロイ（main ブランチへのpush）
- ビルド時に `prisma migrate deploy` 自動実行
- 環境変数は Railway で管理

**データベース**: Railway PostgreSQL
- 本番環境のみ
- ローカルは `postgresql://kouheikameyama@localhost:5432/stock_buddy`

**CI/CD**:
- GitHub Actions でビルド・テスト
- Railway で自動デプロイ

**マイグレーション**:
- ローカル: `npx prisma migrate dev`
- 本番: 自動実行（Railway ビルド時）
- シャドウDBエラー時: 手動マイグレーション作成 + `migrate resolve`

### 13.6 環境変数

**必須**:
- `DATABASE_URL` - PostgreSQL接続文字列
- `AUTH_SECRET` - NextAuth.js シークレット
- `AUTH_GOOGLE_ID` - Google OAuth クライアントID
- `AUTH_GOOGLE_SECRET` - Google OAuth クライアントシークレット
- `OPENAI_API_KEY` - OpenAI API キー
- `RAKUTEN_APPLICATION_ID` - 楽天 Rapid API ID

**オプション**:
- `TAVILY_API_KEY` - ニュース検索API
- `VAPID_PUBLIC_KEY` - プッシュ通知公開鍵
- `VAPID_PRIVATE_KEY` - プッシュ通知秘密鍵
- `VAPID_SUBJECT` - プッシュ通知送信者
- `CRON_SECRET` - cron API認証用

**GitHub Secrets**:
- `APP_URL` - アプリケーションURL
- `SLACK_WEBHOOK_URL` - 通知用Webhook
- `CI_SLACK_WEBHOOK_URL` - CI通知用Webhook

---

_最終更新: 2026-01-30_
_Version: 2.1_
