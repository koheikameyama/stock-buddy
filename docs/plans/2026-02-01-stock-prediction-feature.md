# éŠ˜æŸ„å‹•å‘äºˆæ¸¬æ©Ÿèƒ½ã®è¨­è¨ˆ

## æ¦‚è¦

ãƒã‚¤éŠ˜æŸ„ã®å„éŠ˜æŸ„ã«å¯¾ã—ã¦ã€AIã«ã‚ˆã‚‹å‹•å‘äºˆæ¸¬ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½ã€‚

### ç›®çš„

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œä»Šå¾Œã©ã†ãªã‚‹ã‹ã€ã‚’ç°¡å˜ã«çŸ¥ã‚Œã‚‹
- åˆå¿ƒè€…ã§ã‚‚ç†è§£ã—ã‚„ã™ã„ã‚·ãƒ³ãƒ—ãƒ«ãªè¡¨ç¤º
- æ¯æ—¥æ›´æ–°ã§å¸¸ã«æœ€æ–°ã®äºˆæ¸¬ã‚’æä¾›

### æ–¹é‡

- **è¡¨ç¤º**: ã‚·ãƒ³ãƒ—ãƒ«ï¼ˆçŸ­æœŸãƒ»ä¸­æœŸãƒ»é•·æœŸã®3æ®µéšï¼‰
- **æŠ€è¡“**: ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ + AIï¼ˆãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ–¹å¼ï¼‰
- **æ›´æ–°é »åº¦**: æ¯æ—¥ï¼ˆGitHub Actions ã§è‡ªå‹•å®Ÿè¡Œï¼‰
- **ã‚³ã‚¹ãƒˆ**: gpt-4o-mini ã§æœˆé¡ $1-2 ç¨‹åº¦

## UIè¨­è¨ˆ

### ãƒã‚¤éŠ˜æŸ„ã®è¡¨ç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Š (7203)ã€‘                 â”‚
â”‚ 2,500å†† â–²50å†† (+2.0%)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚ ğŸ“Š ä¿æœ‰çŠ¶æ³                             â”‚
â”‚ â”œâ”€ ä¿æœ‰æ•°: 100æ ª                        â”‚
â”‚ â”œâ”€ å¹³å‡å–å¾—å˜ä¾¡: 2,450å††                â”‚
â”‚ â””â”€ æç›Š: +5,000å†† (+2.0%)               â”‚
â”‚                                         â”‚
â”‚ ğŸ”® ä»Šå¾Œã®äºˆæ¸¬                           â”‚
â”‚ â”œâ”€ çŸ­æœŸï¼ˆ1é€±é–“ï¼‰: ğŸ“ˆ ä¸Šæ˜‡å‚¾å‘          â”‚
â”‚ â”‚   äºˆæƒ³ 2,520å††ã€œ2,580å††               â”‚
â”‚ â”œâ”€ ä¸­æœŸï¼ˆ1ãƒ¶æœˆï¼‰: ğŸ“Š æ¨ªã°ã„            â”‚
â”‚ â”‚   äºˆæƒ³ 2,450å††ã€œ2,600å††               â”‚
â”‚ â””â”€ é•·æœŸï¼ˆ3ãƒ¶æœˆï¼‰: ğŸ“ˆ ç·©ã‚„ã‹ãªä¸Šæ˜‡      â”‚
â”‚     äºˆæƒ³ 2,600å††ã€œ2,800å††               â”‚
â”‚                                         â”‚
â”‚ ğŸ’¡ AIã‚¢ãƒ‰ãƒã‚¤ã‚¹                         â”‚
â”‚ ã€Œç¾åœ¨ã¯ä¿æœ‰ç¶™ç¶šãŒãŠã™ã™ã‚ã§ã™ã€‚        â”‚
â”‚  æ¥­ç¸¾ãŒå®‰å®šã—ã¦ãŠã‚Šã€ä»Šå¾Œã‚‚æˆé•·ãŒ      â”‚
â”‚  æœŸå¾…ã§ãã¾ã™ã€‚ã€                       â”‚
â”‚                                         â”‚
â”‚ ğŸ“… äºˆæ¸¬æ›´æ–°: 2024/02/01 7:00            â”‚
â”‚                                         â”‚
â”‚ [è©³ã—ãè¦‹ã‚‹] [ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è³¼å…¥è¨˜éŒ²ãªã—ã®éŠ˜æŸ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€ã‚½ãƒ‹ãƒ¼G (6758)ã€‘                      â”‚
â”‚ 12,000å†† â–¼200å†† (-1.6%)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚ ğŸ“Š è³¼å…¥è¨˜éŒ²ãªã—                         â”‚
â”‚                                         â”‚
â”‚ ğŸ”® ä»Šå¾Œã®äºˆæ¸¬                           â”‚
â”‚ â”œâ”€ çŸ­æœŸï¼ˆ1é€±é–“ï¼‰: ğŸ“‰ ä¸‹é™å‚¾å‘          â”‚
â”‚ â”‚   äºˆæƒ³ 11,500å††ã€œ11,800å††             â”‚
â”‚ â”œâ”€ ä¸­æœŸï¼ˆ1ãƒ¶æœˆï¼‰: ğŸ“Š æ¨ªã°ã„            â”‚
â”‚ â”‚   äºˆæƒ³ 11,400å††ã€œ12,200å††             â”‚
â”‚ â””â”€ é•·æœŸï¼ˆ3ãƒ¶æœˆï¼‰: ğŸ“ˆ ä¸Šæ˜‡              â”‚
â”‚     äºˆæƒ³ 12,500å††ã€œ13,500å††             â”‚
â”‚                                         â”‚
â”‚ ğŸ’¡ AIã‚¢ãƒ‰ãƒã‚¤ã‚¹                         â”‚
â”‚ ã€ŒçŸ­æœŸçš„ã«ä¸‹ãŒã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚      â”‚
â”‚  11,500å††ã¾ã§ä¸‹ãŒã£ãŸã‚‰è²·ã„æ™‚ã‹ã‚‚      â”‚
â”‚  ã—ã‚Œã¾ã›ã‚“ã€‚ã€                         â”‚
â”‚                                         â”‚
â”‚ ğŸ“… äºˆæ¸¬æ›´æ–°: 2024/02/01 7:00            â”‚
â”‚                                         â”‚
â”‚ [è³¼å…¥è¨˜éŒ²ã‚’è¿½åŠ ] [ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒˆãƒ¬ãƒ³ãƒ‰ã®è¡¨ç¤ºã‚¢ã‚¤ã‚³ãƒ³

```typescript
const trendIcons = {
  up: 'ğŸ“ˆ',
  neutral: 'ğŸ“Š',
  down: 'ğŸ“‰',
}

const trendLabels = {
  up: 'ä¸Šæ˜‡å‚¾å‘',
  neutral: 'æ¨ªã°ã„',
  down: 'ä¸‹é™å‚¾å‘',
}
```

## ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

### StockAnalysis ãƒ†ãƒ¼ãƒ–ãƒ«

```prisma
// éŠ˜æŸ„ã”ã¨ã®AIåˆ†æãƒ»äºˆæ¸¬
model StockAnalysis {
  id              String    @id @default(cuid())
  stockId         String
  stock           Stock     @relation(fields: [stockId], references: [id], onDelete: Cascade)

  // çŸ­æœŸäºˆæ¸¬ï¼ˆ1é€±é–“ï¼‰
  shortTermTrend      String    // 'up' | 'neutral' | 'down'
  shortTermPriceLow   Decimal   @db.Decimal(12, 2)
  shortTermPriceHigh  Decimal   @db.Decimal(12, 2)

  // ä¸­æœŸäºˆæ¸¬ï¼ˆ1ãƒ¶æœˆï¼‰
  midTermTrend        String    // 'up' | 'neutral' | 'down'
  midTermPriceLow     Decimal   @db.Decimal(12, 2)
  midTermPriceHigh    Decimal   @db.Decimal(12, 2)

  // é•·æœŸäºˆæ¸¬ï¼ˆ3ãƒ¶æœˆï¼‰
  longTermTrend       String    // 'up' | 'neutral' | 'down'
  longTermPriceLow    Decimal   @db.Decimal(12, 2)
  longTermPriceHigh   Decimal   @db.Decimal(12, 2)

  // æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  recommendation      String    // 'buy' | 'hold' | 'sell'
  advice              String    // AIã‹ã‚‰ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹æ–‡ç« 
  confidence          Float     // 0-1ã®ä¿¡é ¼åº¦

  // ãƒ¡ã‚¿æƒ…å ±
  analyzedAt          DateTime  @default(now())
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@unique([stockId, analyzedAt])
  @@index([stockId])
  @@index([analyzedAt])
}
```

## äºˆæ¸¬ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯

### ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ–¹å¼ï¼ˆãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ + AIï¼‰

#### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã§åŸºç¤ãƒ‡ãƒ¼ã‚¿ã‚’è¨ˆç®—

```typescript
async function generateBaselinePrediction(stock: Stock) {
  // 1. éå»ã®ä¾¡æ ¼æ¨ç§»ã‚’å–å¾—
  const priceHistory = await prisma.stockPrice.findMany({
    where: { stockId: stock.id },
    orderBy: { date: 'desc' },
    take: 90, // 3ãƒ¶æœˆåˆ†
  })

  const currentPrice = priceHistory[0].close
  const weekAgo = priceHistory[5]?.close
  const monthAgo = priceHistory[20]?.close
  const threeMonthsAgo = priceHistory[60]?.close

  // 2. ãƒˆãƒ¬ãƒ³ãƒ‰è¨ˆç®—
  const weeklyTrend = calculateTrend(currentPrice, weekAgo)
  const monthlyTrend = calculateTrend(currentPrice, monthAgo)
  const quarterlyTrend = calculateTrend(currentPrice, threeMonthsAgo)

  // 3. ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆå¤‰å‹•å¹…ï¼‰ã‚’è¨ˆç®—
  const volatility = calculateVolatility(priceHistory)

  // 4. ã‚¹ã‚³ã‚¢ã‚’å–å¾—
  const scores = {
    growth: stock.growthScore || 0,
    stability: stock.stabilityScore || 0,
    dividend: stock.dividendScore || 0,
  }

  return {
    currentPrice,
    weeklyTrend,
    monthlyTrend,
    quarterlyTrend,
    volatility,
    scores,
    priceHistory: priceHistory.slice(0, 30), // ç›´è¿‘1ãƒ¶æœˆåˆ†
  }
}

function calculateTrend(current: number, past: number): 'up' | 'neutral' | 'down' {
  if (!past) return 'neutral'
  const change = ((current - past) / past) * 100

  if (change > 2) return 'up'
  if (change < -2) return 'down'
  return 'neutral'
}

function calculateVolatility(prices: Array<{ close: number }>): number {
  // æ¨™æº–åå·®ã‚’è¨ˆç®—
  const values = prices.map(p => p.close)
  const mean = values.reduce((a, b) => a + b) / values.length
  const variance = values.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / values.length
  return Math.sqrt(variance)
}
```

#### ã‚¹ãƒ†ãƒƒãƒ—2: AIã§äºˆæ¸¬ã‚’ç”Ÿæˆ

```typescript
async function generateAIPrediction(stock: Stock, baseline: BaselineData) {
  const prompt = `
ã‚ãªãŸã¯æ ªå¼æŠ•è³‡ã®åˆå¿ƒè€…å‘ã‘ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚
ä»¥ä¸‹ã®éŠ˜æŸ„ã«ã¤ã„ã¦ã€ä»Šå¾Œã®å‹•å‘äºˆæ¸¬ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

ã€éŠ˜æŸ„æƒ…å ±ã€‘
åç§°: ${stock.name}
ãƒ†ã‚£ãƒƒã‚«ãƒ¼: ${stock.tickerCode}
ã‚»ã‚¯ã‚¿ãƒ¼: ${stock.sector}
ç¾åœ¨ä¾¡æ ¼: ${baseline.currentPrice}å††

ã€éå»ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã€‘
- 1é€±é–“: ${baseline.weeklyTrend === 'up' ? 'ä¸Šæ˜‡' : baseline.weeklyTrend === 'down' ? 'ä¸‹é™' : 'æ¨ªã°ã„'}
- 1ãƒ¶æœˆ: ${baseline.monthlyTrend === 'up' ? 'ä¸Šæ˜‡' : baseline.monthlyTrend === 'down' ? 'ä¸‹é™' : 'æ¨ªã°ã„'}
- 3ãƒ¶æœˆ: ${baseline.quarterlyTrend === 'up' ? 'ä¸Šæ˜‡' : baseline.quarterlyTrend === 'down' ? 'ä¸‹é™' : 'æ¨ªã°ã„'}

ã€ã‚¹ã‚³ã‚¢ã€‘
- æˆé•·æ€§: ${baseline.scores.growth}/100
- å®‰å®šæ€§: ${baseline.scores.stability}/100
- é…å½“æ€§: ${baseline.scores.dividend}/100

ã€ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆä¾¡æ ¼å¤‰å‹•å¹…ï¼‰ã€‘
${baseline.volatility.toFixed(2)}å††

---

ä»¥ä¸‹ã®å½¢å¼ã§JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ï¼š

{
  "shortTerm": {
    "trend": "up" | "neutral" | "down",
    "priceLow": æ•°å€¤,
    "priceHigh": æ•°å€¤,
    "reasoning": "çŸ­ã„ç†ç”±ï¼ˆ30æ–‡å­—ä»¥å†…ï¼‰"
  },
  "midTerm": {
    "trend": "up" | "neutral" | "down",
    "priceLow": æ•°å€¤,
    "priceHigh": æ•°å€¤,
    "reasoning": "çŸ­ã„ç†ç”±ï¼ˆ30æ–‡å­—ä»¥å†…ï¼‰"
  },
  "longTerm": {
    "trend": "up" | "neutral" | "down",
    "priceLow": æ•°å€¤,
    "priceHigh": æ•°å€¤,
    "reasoning": "çŸ­ã„ç†ç”±ï¼ˆ30æ–‡å­—ä»¥å†…ï¼‰"
  },
  "recommendation": "buy" | "hold" | "sell",
  "advice": "åˆå¿ƒè€…å‘ã‘ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼ˆ100æ–‡å­—ä»¥å†…ã€å„ªã—ã„è¨€è‘‰ã§ï¼‰",
  "confidence": 0.0ã€œ1.0ã®ä¿¡é ¼åº¦
}

æ³¨æ„äº‹é …:
- ä¾¡æ ¼äºˆæ¸¬ã¯ç¾åœ¨ä¾¡æ ¼ã¨ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’è€ƒæ…®ã—ãŸç¾å®Ÿçš„ãªç¯„å›²ã«ã™ã‚‹
- ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã¯å…·ä½“çš„ã§åˆ†ã‹ã‚Šã‚„ã™ã
- æ–­å®šçš„ãªè¡¨ç¾ã¯é¿ã‘ã€ã€Œã€œãŒæœŸå¾…ã§ãã¾ã™ã€ã€Œã€œã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€ãªã©æŸ”ã‚‰ã‹ã„è¡¨ç¾ã‚’ä½¿ã†
- æŠ•è³‡åˆ¤æ–­ã¯æœ€çµ‚çš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ãŒè¡Œã†ã“ã¨ã‚’å‰æã«ã™ã‚‹
`

  const response = await openai.chat.completions.create({
    model: 'gpt-4o-mini', // ã‚³ã‚¹ãƒˆåŠ¹ç‡é‡è¦–
    messages: [{ role: 'user', content: prompt }],
    response_format: { type: 'json_object' },
    temperature: 0.7,
  })

  const prediction = JSON.parse(response.choices[0].message.content)

  return prediction
}
```

#### ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜

```typescript
async function saveStockAnalysis(stockId: string, prediction: any) {
  const now = new Date()

  await prisma.stockAnalysis.create({
    data: {
      stockId,

      // çŸ­æœŸäºˆæ¸¬
      shortTermTrend: prediction.shortTerm.trend,
      shortTermPriceLow: prediction.shortTerm.priceLow,
      shortTermPriceHigh: prediction.shortTerm.priceHigh,

      // ä¸­æœŸäºˆæ¸¬
      midTermTrend: prediction.midTerm.trend,
      midTermPriceLow: prediction.midTerm.priceLow,
      midTermPriceHigh: prediction.midTerm.priceHigh,

      // é•·æœŸäºˆæ¸¬
      longTermTrend: prediction.longTerm.trend,
      longTermPriceLow: prediction.longTerm.priceLow,
      longTermPriceHigh: prediction.longTerm.priceHigh,

      // ã‚¢ãƒ‰ãƒã‚¤ã‚¹
      recommendation: prediction.recommendation,
      advice: prediction.advice,
      confidence: prediction.confidence,

      analyzedAt: now,
    }
  })
}
```

## Pythonå®Ÿè£…ï¼ˆæ¨å¥¨ï¼‰

### ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```python
# scripts/generate_stock_predictions.py

import os
import sys
import json
import psycopg2
import psycopg2.extras
from openai import OpenAI
from datetime import datetime, timedelta
import statistics

DATABASE_URL = os.getenv("DATABASE_URL")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

client = OpenAI(api_key=OPENAI_API_KEY)

def calculate_trend(current, past):
    """ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’è¨ˆç®—"""
    if not past:
        return 'neutral'

    change = ((current - past) / past) * 100

    if change > 2:
        return 'up'
    elif change < -2:
        return 'down'
    else:
        return 'neutral'

def calculate_volatility(prices):
    """ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆæ¨™æº–åå·®ï¼‰ã‚’è¨ˆç®—"""
    if len(prices) < 2:
        return 0.0
    return statistics.stdev(prices)

def get_baseline_data(cur, stock_id):
    """ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã§åŸºç¤ãƒ‡ãƒ¼ã‚¿ã‚’è¨ˆç®—"""

    # éå»90æ—¥åˆ†ã®ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    cur.execute("""
        SELECT close, date
        FROM "StockPrice"
        WHERE "stockId" = %s
        ORDER BY date DESC
        LIMIT 90
    """, (stock_id,))

    price_history = cur.fetchall()

    if not price_history:
        return None

    current_price = float(price_history[0][0])
    week_ago = float(price_history[5][0]) if len(price_history) > 5 else None
    month_ago = float(price_history[20][0]) if len(price_history) > 20 else None
    three_months_ago = float(price_history[60][0]) if len(price_history) > 60 else None

    # ãƒˆãƒ¬ãƒ³ãƒ‰è¨ˆç®—
    weekly_trend = calculate_trend(current_price, week_ago)
    monthly_trend = calculate_trend(current_price, month_ago)
    quarterly_trend = calculate_trend(current_price, three_months_ago)

    # ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£è¨ˆç®—
    prices = [float(p[0]) for p in price_history[:30]]
    volatility = calculate_volatility(prices)

    return {
        'current_price': current_price,
        'weekly_trend': weekly_trend,
        'monthly_trend': monthly_trend,
        'quarterly_trend': quarterly_trend,
        'volatility': volatility,
    }

def generate_ai_prediction(stock, baseline, scores):
    """AIã§äºˆæ¸¬ã‚’ç”Ÿæˆ"""

    trend_labels = {
        'up': 'ä¸Šæ˜‡',
        'neutral': 'æ¨ªã°ã„',
        'down': 'ä¸‹é™'
    }

    prompt = f"""
ã‚ãªãŸã¯æ ªå¼æŠ•è³‡ã®åˆå¿ƒè€…å‘ã‘ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚
ä»¥ä¸‹ã®éŠ˜æŸ„ã«ã¤ã„ã¦ã€ä»Šå¾Œã®å‹•å‘äºˆæ¸¬ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

ã€éŠ˜æŸ„æƒ…å ±ã€‘
åç§°: {stock['name']}
ãƒ†ã‚£ãƒƒã‚«ãƒ¼: {stock['ticker_code']}
ã‚»ã‚¯ã‚¿ãƒ¼: {stock['sector'] or 'ä¸æ˜'}
ç¾åœ¨ä¾¡æ ¼: {baseline['current_price']}å††

ã€éå»ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã€‘
- 1é€±é–“: {trend_labels[baseline['weekly_trend']]}
- 1ãƒ¶æœˆ: {trend_labels[baseline['monthly_trend']]}
- 3ãƒ¶æœˆ: {trend_labels[baseline['quarterly_trend']]}

ã€ã‚¹ã‚³ã‚¢ã€‘
- æˆé•·æ€§: {scores['growth']}/100
- å®‰å®šæ€§: {scores['stability']}/100
- é…å½“æ€§: {scores['dividend']}/100

ã€ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆä¾¡æ ¼å¤‰å‹•å¹…ï¼‰ã€‘
{baseline['volatility']:.2f}å††

---

ä»¥ä¸‹ã®å½¢å¼ã§JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ï¼š

{{
  "shortTerm": {{
    "trend": "up" | "neutral" | "down",
    "priceLow": æ•°å€¤,
    "priceHigh": æ•°å€¤
  }},
  "midTerm": {{
    "trend": "up" | "neutral" | "down",
    "priceLow": æ•°å€¤,
    "priceHigh": æ•°å€¤
  }},
  "longTerm": {{
    "trend": "up" | "neutral" | "down",
    "priceLow": æ•°å€¤,
    "priceHigh": æ•°å€¤
  }},
  "recommendation": "buy" | "hold" | "sell",
  "advice": "åˆå¿ƒè€…å‘ã‘ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼ˆ100æ–‡å­—ä»¥å†…ã€å„ªã—ã„è¨€è‘‰ã§ï¼‰",
  "confidence": 0.0ã€œ1.0ã®ä¿¡é ¼åº¦
}}

æ³¨æ„äº‹é …:
- ä¾¡æ ¼äºˆæ¸¬ã¯ç¾åœ¨ä¾¡æ ¼ã¨ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’è€ƒæ…®ã—ãŸç¾å®Ÿçš„ãªç¯„å›²ã«ã™ã‚‹
- ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã¯å…·ä½“çš„ã§åˆ†ã‹ã‚Šã‚„ã™ã
- æ–­å®šçš„ãªè¡¨ç¾ã¯é¿ã‘ã€ã€Œã€œãŒæœŸå¾…ã§ãã¾ã™ã€ã€Œã€œã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€ãªã©æŸ”ã‚‰ã‹ã„è¡¨ç¾ã‚’ä½¿ã†
"""

    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[{"role": "user", "content": prompt}],
        response_format={"type": "json_object"},
        temperature=0.7,
    )

    prediction = json.loads(response.choices[0].message.content)
    return prediction

def save_prediction(cur, stock_id, prediction):
    """äºˆæ¸¬ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜"""

    cur.execute("""
        INSERT INTO "StockAnalysis" (
            id, "stockId",
            "shortTermTrend", "shortTermPriceLow", "shortTermPriceHigh",
            "midTermTrend", "midTermPriceLow", "midTermPriceHigh",
            "longTermTrend", "longTermPriceLow", "longTermPriceHigh",
            recommendation, advice, confidence,
            "analyzedAt", "createdAt", "updatedAt"
        )
        VALUES (
            gen_random_uuid(), %s,
            %s, %s, %s,
            %s, %s, %s,
            %s, %s, %s,
            %s, %s, %s,
            NOW(), NOW(), NOW()
        )
    """, (
        stock_id,
        prediction['shortTerm']['trend'],
        prediction['shortTerm']['priceLow'],
        prediction['shortTerm']['priceHigh'],
        prediction['midTerm']['trend'],
        prediction['midTerm']['priceLow'],
        prediction['midTerm']['priceHigh'],
        prediction['longTerm']['trend'],
        prediction['longTerm']['priceLow'],
        prediction['longTerm']['priceHigh'],
        prediction['recommendation'],
        prediction['advice'],
        prediction['confidence'],
    ))

def main():
    print("ğŸš€ Starting stock predictions generation...")

    conn = psycopg2.connect(DATABASE_URL)
    cur = conn.cursor(cursor_factory=psycopg2.extras.DictCursor)

    # ã™ã¹ã¦ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªéŠ˜æŸ„ã‚’å–å¾—
    cur.execute("""
        SELECT id, "tickerCode", name, sector,
               "growthScore", "stabilityScore", "dividendScore"
        FROM "Stock"
        WHERE "isActive" = true
    """)

    stocks = cur.fetchall()
    total = len(stocks)
    success = 0
    failed = 0

    print(f"ğŸ“Š Processing {total} stocks...")

    for i, stock in enumerate(stocks, 1):
        stock_dict = {
            'id': stock['id'],
            'ticker_code': stock['tickerCode'],
            'name': stock['name'],
            'sector': stock['sector'],
        }

        scores = {
            'growth': stock['growthScore'] or 0,
            'stability': stock['stabilityScore'] or 0,
            'dividend': stock['dividendScore'] or 0,
        }

        try:
            print(f"[{i}/{total}] Processing {stock_dict['name']} ({stock_dict['ticker_code']})...")

            # 1. åŸºç¤ãƒ‡ãƒ¼ã‚¿è¨ˆç®—
            baseline = get_baseline_data(cur, stock_dict['id'])

            if not baseline:
                print(f"  âš ï¸  No price data available, skipping...")
                failed += 1
                continue

            # 2. AIäºˆæ¸¬ç”Ÿæˆ
            prediction = generate_ai_prediction(stock_dict, baseline, scores)

            # 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
            save_prediction(cur, stock_dict['id'], prediction)

            conn.commit()
            success += 1
            print(f"  âœ… Saved ({prediction['recommendation']})")

        except Exception as e:
            print(f"  âŒ Error: {e}")
            conn.rollback()
            failed += 1

    cur.close()
    conn.close()

    print(f"\nğŸ‰ Completed!")
    print(f"  âœ… Success: {success}")
    print(f"  âŒ Failed: {failed}")
    print(f"  ğŸ“Š Total: {total}")

    if failed > 0:
        sys.exit(1)

if __name__ == "__main__":
    main()
```

## GitHub Actions ã«ã‚ˆã‚‹æ¯æ—¥å®Ÿè¡Œ

```yaml
# .github/workflows/daily-stock-predictions.yml

name: Daily Stock Predictions

on:
  schedule:
    # æ¯æ—¥ æœ7æ™‚ï¼ˆJSTï¼‰= å‰æ—¥22æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ
    - cron: '0 22 * * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  generate-predictions:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install psycopg2-binary openai

      - name: Generate stock predictions
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: python scripts/generate_stock_predictions.py

      - name: Notify on failure
        if: failure()
        run: echo "Stock predictions generation failed!"
```

## API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

### éŠ˜æŸ„ã®äºˆæ¸¬ã‚’å–å¾—

```typescript
// app/api/stocks/[stockId]/analysis/route.ts

import { NextRequest, NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'

export async function GET(
  request: NextRequest,
  { params }: { params: { stockId: string } }
) {
  try {
    const analysis = await prisma.stockAnalysis.findFirst({
      where: { stockId: params.stockId },
      orderBy: { analyzedAt: 'desc' },
    })

    if (!analysis) {
      return NextResponse.json(
        { error: 'Analysis not found' },
        { status: 404 }
      )
    }

    return NextResponse.json({
      shortTerm: {
        trend: analysis.shortTermTrend,
        priceLow: analysis.shortTermPriceLow.toString(),
        priceHigh: analysis.shortTermPriceHigh.toString(),
      },
      midTerm: {
        trend: analysis.midTermTrend,
        priceLow: analysis.midTermPriceLow.toString(),
        priceHigh: analysis.midTermPriceHigh.toString(),
      },
      longTerm: {
        trend: analysis.longTermTrend,
        priceLow: analysis.longTermPriceLow.toString(),
        priceHigh: analysis.longTermPriceHigh.toString(),
      },
      recommendation: analysis.recommendation,
      advice: analysis.advice,
      confidence: analysis.confidence,
      analyzedAt: analysis.analyzedAt,
    })
  } catch (error) {
    console.error('Error fetching stock analysis:', error)
    return NextResponse.json(
      { error: 'Failed to fetch analysis' },
      { status: 500 }
    )
  }
}
```

## ã‚³ã‚¹ãƒˆè©¦ç®—

### OpenAI API ã‚³ã‚¹ãƒˆ

**gpt-4o-mini æ–™é‡‘:**
- Input: $0.150 / 1M tokens
- Output: $0.600 / 1M tokens

**1éŠ˜æŸ„ã‚ãŸã‚Š:**
- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: ç´„500ãƒˆãƒ¼ã‚¯ãƒ³ = $0.000075
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹: ç´„300ãƒˆãƒ¼ã‚¯ãƒ³ = $0.000180
- åˆè¨ˆ: ç´„ $0.000255

**æ¯æ—¥100éŠ˜æŸ„ã‚’åˆ†æ:**
- 1æ—¥: 100éŠ˜æŸ„ Ã— $0.000255 = $0.0255
- 1ãƒ¶æœˆ: $0.0255 Ã— 30 = $0.765
- å¹´é–“: $0.765 Ã— 12 = $9.18

**éå¸¸ã«ä½ã‚³ã‚¹ãƒˆï¼**

## å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º

### ãƒ•ã‚§ãƒ¼ã‚º1: ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ

1. Prismaã‚¹ã‚­ãƒ¼ãƒã« `StockAnalysis` ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ 
2. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
3. Python ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
4. ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

### ãƒ•ã‚§ãƒ¼ã‚º2: GitHub Actions è¨­å®š

1. `.github/workflows/daily-stock-predictions.yml` ä½œæˆ
2. ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆè¨­å®šï¼ˆ`OPENAI_API_KEY`ï¼‰
3. æ‰‹å‹•å®Ÿè¡Œã§ãƒ†ã‚¹ãƒˆ

### ãƒ•ã‚§ãƒ¼ã‚º3: API ã¨UIå®Ÿè£…

1. `/api/stocks/[stockId]/analysis` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä½œæˆ
2. ãƒã‚¤éŠ˜æŸ„ç”»é¢ã«äºˆæ¸¬è¡¨ç¤ºã‚’è¿½åŠ 
3. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ»ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ãƒ•ã‚§ãƒ¼ã‚º4: ãƒªãƒªãƒ¼ã‚¹

1. æœ¬ç•ªç’°å¢ƒã§GitHub Actionså®Ÿè¡Œ
2. æ¯æ—¥æœ7æ™‚ã«è‡ªå‹•æ›´æ–°
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ©Ÿèƒ½ã‚’ã‚¢ãƒŠã‚¦ãƒ³ã‚¹

## æ³¨æ„äº‹é …ã¨ãƒªã‚¹ã‚¯

### å…è²¬äº‹é …

**ã‚¢ãƒ—ãƒªã«è¡¨ç¤ºã™ã‚‹æ³¨æ„æ›¸ã:**

```
âš ï¸ æŠ•è³‡åˆ¤æ–­ã«ã¤ã„ã¦

ã“ã®äºˆæ¸¬ã¯AIã«ã‚ˆã‚‹åˆ†æçµæœã§ã‚ã‚Šã€å°†æ¥ã®æ ªä¾¡ã‚’
ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æŠ•è³‡åˆ¤æ–­ã¯å¿…ãšã”è‡ªèº«ã®
è²¬ä»»ã§è¡Œã£ã¦ãã ã•ã„ã€‚

äºˆæ¸¬ã®ç²¾åº¦ã«ã¯é™ç•ŒãŒã‚ã‚Šã€å¸‚å ´ã®æ€¥æ¿€ãªå¤‰å‹•ã‚„
äºˆæœŸã›ã¬å‡ºæ¥äº‹ã«ã‚ˆã£ã¦ã€å®Ÿéš›ã®æ ªä¾¡ã¯äºˆæ¸¬ã‹ã‚‰
å¤§ããå¤–ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
```

### ãƒ‡ãƒ¼ã‚¿å“è³ª

- æ ªä¾¡ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã‚‹éŠ˜æŸ„ã¯ã‚¹ã‚­ãƒƒãƒ—
- ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸéŠ˜æŸ„ã¯ãƒ­ã‚°ã«è¨˜éŒ²
- æˆåŠŸç‡ã‚’ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

### ã‚³ã‚¹ãƒˆç®¡ç†

- æœˆé¡ã‚³ã‚¹ãƒˆãŒäºˆç®—ã‚’è¶…ãˆãŸå ´åˆã¯ã‚¢ãƒ©ãƒ¼ãƒˆ
- å¿…è¦ã«å¿œã˜ã¦åˆ†æå¯¾è±¡éŠ˜æŸ„ã‚’çµã‚‹
- gpt-4o-mini ã§ååˆ†ãªç²¾åº¦ãŒå‡ºãªã„å ´åˆã¯ gpt-4o ã«å¤‰æ›´ã‚’æ¤œè¨

## ä»Šå¾Œã®æ‹¡å¼µ

### å°†æ¥çš„ãªæ©Ÿèƒ½

1. **äºˆæ¸¬ç²¾åº¦ã®è¿½è·¡**
   - äºˆæ¸¬ã¨å®Ÿéš›ã®ä¾¡æ ¼ã‚’æ¯”è¼ƒ
   - AIãƒ¢ãƒ‡ãƒ«ã®ç²¾åº¦ã‚’ç¶™ç¶šçš„ã«æ”¹å–„

2. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º**
   - æŠ•è³‡ã‚¹ã‚¿ã‚¤ãƒ«ã«å¿œã˜ãŸäºˆæ¸¬
   - ãƒªã‚¹ã‚¯è¨±å®¹åº¦ã‚’åæ˜ 

3. **ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½ã¨ã®é€£æº**
   - äºˆæ¸¬ãŒå¤§ããå¤‰ã‚ã£ãŸæ™‚ã«é€šçŸ¥
   - è²·ã„æ™‚ãƒ»å£²ã‚Šæ™‚ã®æ¨å¥¨ãŒå¤‰ã‚ã£ãŸæ™‚ã«é€šçŸ¥

4. **è©³ç´°åˆ†æãƒšãƒ¼ã‚¸**
   - ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º
   - éå»ã®äºˆæ¸¬å±¥æ­´
   - äºˆæ¸¬ç²¾åº¦ã®è¡¨ç¤º
