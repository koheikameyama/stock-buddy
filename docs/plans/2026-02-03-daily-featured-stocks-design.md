# DailyFeaturedStock自動生成機能 設計書

**作成日**: 2026-02-03
**目的**: ユーザーの投資スタイルに応じた注目銘柄を毎日自動生成する

## 背景

現在、`DailyFeaturedStock`テーブルは存在するが、データを生成するロジックが実装されていない。そのため、全ての銘柄が`category="stable"`として表示され、ユーザーの投資スタイル（短期・リスク高など）が反映されていない。

## 目的

株価変動率、取引高、初心者スコアから機械的に銘柄を3カテゴリ（surge/stable/trending）に分類し、毎日自動更新することで、ユーザーにパーソナライズされた注目銘柄を提供する。

## 設計方針

- **既存データから機械的に分類**: OpenAI APIを使わず、コストを抑える
- **初心者向けの説明文**: 専門用語を避け、選定根拠を分かりやすく表示
- **株価予測と同じタイミング**: 既存ワークフローに統合し、管理を簡素化

## アーキテクチャ

### 全体構成

```
GitHub Actions (毎日朝7時JST)
  ↓
株価データ取得 (既存)
  ↓
株価予測生成 (既存)
  ↓
購入判断生成 (既存)
  ↓
ポートフォリオ分析 (既存)
  ↓
【NEW】DailyFeaturedStock生成
  ├─ 株価データ取得
  ├─ カテゴリ別に銘柄を抽出
  ├─ Top 3選出 (合計9銘柄)
  ├─ 選定根拠を生成
  └─ DailyFeaturedStockテーブル更新
```

### コンポーネント

1. **Pythonスクリプト**: `scripts/github-actions/generate_daily_featured_stocks.py`
2. **GitHub Actions**: `.github/workflows/stock-predictions.yml`に1ステップ追加
3. **データベーステーブル**: `DailyFeaturedStock`（既存）

## 分類ロジック

### 前提条件

- **対象銘柄**: Stockテーブルの全銘柄（株価データがある銘柄のみ）
- **更新頻度**: 毎日1回（朝7時JST）
- **選出数**: 各カテゴリTop 3（合計9銘柄/日）

### カテゴリ別判定基準

#### 1. surge（短期急騰）

**条件:**
- 7日間の株価上昇率: +5%以上
- 初心者スコア: 50点以上

**計算方法:**
```python
上昇率 = (今日の終値 - 7日前の終値) / 7日前の終値 × 100
```

**選定根拠の例:**
```
この1週間で株価が6.2%上昇しています。初心者でも安心して投資できる銘柄です（スコア75点）
```

**ソート順**: 上昇率が高い順

---

#### 2. stable（中長期安定）

**条件:**
- 初心者スコア: 70点以上
- 30日間のボラティリティ: 15%以下

**計算方法:**
```python
ボラティリティ = 過去30日間の終値の標準偏差 / 平均終値 × 100
```

**選定根拠の例:**
```
安定した値動きで、初心者に最適な銘柄です（スコア85点、変動率8.5%）
```

**ソート順**: 初心者スコアが高い順

---

#### 3. trending（話題）

**条件:**
- 7日間の平均取引高 > 過去30日間の平均取引高 × 1.5倍
- 初心者スコア: 40点以上

**計算方法:**
```python
取引高増加率 = 直近7日平均取引高 / 過去30日平均取引高
```

**選定根拠の例:**
```
最近取引が活発になっている注目銘柄です（取引高1.8倍、スコア65点）
```

**ソート順**: 取引高増加率が高い順

## データフロー

### 実行フロー

```
1. GitHub Actions起動（毎日朝7時JST）
   ↓
2. 株価データ取得（既存ステップ）
   ↓
3. 株価予測生成（既存ステップ）
   ↓
4. 購入判断生成（既存ステップ）
   ↓
5. ポートフォリオ分析（既存ステップ）
   ↓
6. 【NEW】DailyFeaturedStock生成
   ├─ データベース接続
   ├─ 全銘柄の株価データを取得（過去30日分）
   ├─ surge: 7日間上昇率を計算 → Top 3選出
   ├─ stable: ボラティリティを計算 → Top 3選出
   ├─ trending: 取引高増加率を計算 → Top 3選出
   ├─ 選定根拠を初心者向けに生成
   ├─ 既存データ削除（今日の日付）
   └─ 新データを挿入（9銘柄）
```

### データベース操作

**更新方法:**

```sql
-- 既存データを削除（今日の日付）
DELETE FROM "DailyFeaturedStock" WHERE date = '2026-02-03';

-- 新しいデータを挿入
INSERT INTO "DailyFeaturedStock"
  (date, "stockId", category, position, reason, score, "createdAt")
VALUES
  ('2026-02-03', 'stock1', 'surge', 1, 'この1週間で株価が6.2%上昇...', 75, NOW()),
  ('2026-02-03', 'stock2', 'surge', 2, 'この1週間で株価が5.8%上昇...', 72, NOW()),
  ('2026-02-03', 'stock3', 'surge', 3, 'この1週間で株価が5.5%上昇...', 68, NOW()),
  ('2026-02-03', 'stock4', 'stable', 1, '安定した値動きで、初心者に...', 85, NOW()),
  ('2026-02-03', 'stock5', 'stable', 2, '安定した値動きで、初心者に...', 82, NOW()),
  ('2026-02-03', 'stock6', 'stable', 3, '安定した値動きで、初心者に...', 78, NOW()),
  ('2026-02-03', 'stock7', 'trending', 1, '最近取引が活発になっている...', 68, NOW()),
  ('2026-02-03', 'stock8', 'trending', 2, '最近取引が活発になっている...', 65, NOW()),
  ('2026-02-03', 'stock9', 'trending', 3, '最近取引が活発になっている...', 62, NOW());
```

## エラーハンドリング

### 1. 株価データが不足している場合

- **対応**: スキップして次の銘柄へ
- **ログ**: `⚠️ No price data for トヨタ自動車, skipping`

### 2. カテゴリの該当銘柄が3件未満の場合

- **対応**: 該当銘柄のみ登録（3件未満でもOK）
- **ログ**: `⚠️ Only 2 stocks found for 'surge' category`

### 3. データベース接続エラー

- **対応**: リトライ1回（5秒待機後）
- **失敗時**: exit(1)でGitHub Actionsを失敗させる

### 4. 全カテゴリで0件の場合

- **対応**: 警告を出して正常終了（exit(0)）
- **ログ**: `⚠️ No stocks matched criteria today`

## 既存システムへの影響

### 変更が必要な箇所

- **GitHub Actions**: `.github/workflows/stock-predictions.yml`に1ステップ追加

### 変更不要な箇所

- **API**: `/api/featured-stocks`はそのまま動作
- **UI**: `DashboardClient.tsx`、`FeaturedStocksByCategory.tsx`は変更不要
- **データベーススキーマ**: `DailyFeaturedStock`テーブルはそのまま使用

## テスト計画

### 1. ローカルテスト

```bash
# ローカルDBで実行
DATABASE_URL="postgresql://..." python scripts/github-actions/generate_daily_featured_stocks.py
```

**確認項目:**
- [ ] 9銘柄が正しく登録される
- [ ] 各カテゴリに3銘柄ずつ（該当がない場合は少なくてもOK）
- [ ] `reason`フィールドに初心者向けの説明が入る
- [ ] エラーハンドリングが動作する

### 2. 本番DBテスト

```bash
# 本番DBで実行（GitHub Actionsの手動実行）
gh workflow run stock-predictions.yml
```

**確認項目:**
- [ ] DailyFeaturedStockに今日の日付でデータが入る
- [ ] ダッシュボードで注目銘柄が表示される
- [ ] 投資スタイル「短期・リスク高」でsurge銘柄が優先表示される

### 3. UI確認

**確認項目:**
- [ ] surge銘柄に「📈 短期急騰」が表示される
- [ ] stable銘柄に「🛡️ 安定」が表示される
- [ ] trending銘柄に「🔥 話題」が表示される
- [ ] 選定根拠が読みやすい日本語で表示される

## デプロイ計画

1. Pythonスクリプト作成
2. GitHub Actions統合
3. ローカルでテスト実行
4. 本番DBでテスト実行（手動トリガー）
5. UI確認
6. 自動実行を有効化

## 将来の拡張性

### 考慮した拡張ポイント

- **カテゴリ追加**: 新しいカテゴリ（例: 配当株）を追加しやすい設計
- **選出数の変更**: Top 3 → Top 5などに柔軟に変更可能
- **AI分析への移行**: 将来的にOpenAI APIで分析に切り替えることも可能

### YAGNIで除外した機能

- **複数日分の一括生成**: 毎日1日分のみ生成（シンプルに）
- **ユーザーごとのカスタマイズ**: 全ユーザー共通の銘柄を提供
- **リアルタイム更新**: 1日1回の更新で十分

## まとめ

この設計により、ユーザーの投資スタイルに応じたパーソナライズされた注目銘柄を毎日自動で提供できるようになる。株価変動率ベースの機械的な分類により、コストを抑えつつ、初心者にも分かりやすい説明を提供する。
