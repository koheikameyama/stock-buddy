# ポートフォリオ・ウォッチリスト統合設計

## 背景

### 現状の問題点

1. **概念の複雑さ**
   - ポートフォリオとウォッチリストの2つのタブ
   - 「実際に購入」「シミュレーション」「ウォッチリスト」の3つの状態
   - 初心者には使い分けが難しい

2. **実質的な違いがない**
   - Stock Buddyは証券口座と連携していない
   - すべてユーザーの自己申告
   - 「実際に購入」も「シミュレーション」もアプリ上では同じ
   - 表示内容もほぼ同じ（価格・変動・損益）

3. **ユーザーの本当のニーズ**
   - 気になる銘柄の価格を知りたい
   - 買った（つもりの）銘柄の損益を知りたい
   - いつ買うべきか、いつ売るべきか判断したい

   → すべて「気になる銘柄を管理したい」に集約される

## 設計方針

### コンセプト: 「マイ銘柄」の一元管理

- タブを廃止し、1つのリストに統合
- 購入記録がある銘柄 → 損益計算を表示
- 購入記録がない銘柄 → 価格のみ表示
- ユーザーは「記録する/しない」を自由に選べる
- 「実際/シミュレーション」の区別は廃止

### 初心者に優しい設計

- ✅ シンプル: タブ切り替え不要
- ✅ 柔軟: 買ってなくても、買ったつもりでも記録できる
- ✅ 直感的: 複雑な概念がない
- ✅ 段階的: 最初は価格だけ見て、慣れたら記録を追加

## データモデル設計

### 統合後のモデル構造

```prisma
// ユーザーごとの銘柄リスト（統合）
model MyStock {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  stockId   String
  stock     Stock    @relation(fields: [stockId], references: [id], onDelete: Cascade)

  // 購入記録（任意）
  hasPurchaseRecord Boolean  @default(false)
  quantity          Int?     // 株数（記録がある場合のみ）
  averagePrice      Decimal? @db.Decimal(12, 2) // 平均取得単価（記録がある場合のみ）

  // 購入履歴（トランザクション）は別テーブルで保持
  transactions      Transaction[]

  // 価格アラート
  targetPrice       Decimal?  @db.Decimal(12, 2)
  targetCondition   String?   // 'above' | 'below'
  priceAlert        Boolean   @default(false)
  lastAlertSent     DateTime?

  // メモ
  note              String?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([userId, stockId])
  @@index([userId])
  @@index([userId, priceAlert])
}

// 購入・売却トランザクション
model Transaction {
  id              String    @id @default(cuid())
  myStockId       String
  myStock         MyStock   @relation(fields: [myStockId], references: [id], onDelete: Cascade)

  type            String    // 'buy' | 'sell'
  quantity        Int
  price           Decimal   @db.Decimal(12, 2)
  date            DateTime
  note            String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([myStockId])
  @@index([date])
}
```

### 既存モデルからの移行

**削除するモデル:**
- `Portfolio` - 不要（ユーザーごとに1つという概念を廃止）
- `PortfolioStock` - `MyStock`に統合
- `Watchlist` - `MyStock`に統合

**残すモデル:**
- `Transaction` - 購入・売却履歴は重要（設計変更）
- `Stock` - 銘柄マスタ
- `StockPrice` - 株価履歴

## UI/UX設計

### 画面構成

```
┌─────────────────────────────────────────┐
│ マイ銘柄 (3/5)              [+ 銘柄追加] │
├─────────────────────────────────────────┤
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 【トヨタ自動車 (7203)】             │ │
│ │ 2,500円 ▲50円 (+2.0%)   [削除]     │ │
│ │                                     │ │
│ │ 📊 保有記録                         │ │
│ │ ├─ 100株 @2,450円                  │ │
│ │ ├─ 取得日: 2024/01/15              │ │
│ │ └─ 損益: +5,000円 (+2.0%)          │ │
│ │                                     │ │
│ │ 🔔 価格アラート: なし               │ │
│ │                                     │ │
│ │ [記録を編集] [アラート設定]         │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 【ソニーG (6758)】                  │ │
│ │ 12,000円 ▼200円 (-1.6%)  [削除]    │ │
│ │                                     │ │
│ │ 📊 保有記録: なし                   │ │
│ │                                     │ │
│ │ 🔔 アラート: 11,500円を下回ったら通知│ │
│ │                                     │ │
│ │ [購入記録を追加] [アラート編集]     │ │
│ └─────────────────────────────────────┘ │
│                                         │
└─────────────────────────────────────────┘
```

### 表示パターン

#### パターンA: 購入記録あり
```
【トヨタ自動車】2,500円 ▲50円(+2.0%)
├─ 📊 100株 @2,450円で保有
├─ 💰 損益: +5,000円 (+2.0%)
├─ 📅 取得日: 2024/01/15
└─ 🔔 アラート: なし
```

#### パターンB: 購入記録なし（価格監視のみ）
```
【ソニーG】12,000円 ▼200円(-1.6%)
├─ 📊 保有記録: なし
└─ 🔔 アラート: 11,500円を下回ったら通知
```

### アクション

**購入記録がある場合:**
- [記録を編集] - 株数・取得単価・取得日を編集
- [追加購入] - 新しいトランザクションを追加
- [一部売却] - 売却トランザクションを追加
- [全て売却] - 売却して記録を削除
- [アラート設定] - 価格アラートを設定
- [削除] - マイ銘柄から削除

**購入記録がない場合:**
- [購入記録を追加] - 株数・取得単価・取得日を入力
- [アラート設定] - 価格アラートを設定
- [削除] - マイ銘柄から削除

## オンボーディング設計

### 重要: AIの提案機能は維持

オンボーディングの価値 = **「何を・何株・いくらで買うべきか」を初心者に提案すること**

この機能は変更せず、むしろ強化する。

### 新しいフロー

```
1. 投資スタイル診断
   - 予算（例: 10万円）
   - 投資期間（例: 長期）
   - リスク許容度（例: 低い）
   ↓
2. AIが具体的なポートフォリオを提案
   「あなたには4銘柄、合計10万円の分散投資がおすすめです」

   - トヨタ自動車: 10株 × 2,500円 = 25,000円
   - ソニーG: 2株 × 12,000円 = 24,000円
   - 三菱UFJ: 20株 × 1,200円 = 24,000円
   - NTT: 100株 × 150円 = 15,000円

   合計: 88,000円
   ↓
3. 各銘柄に対して選択:

   ┌─────────────────────────────────────┐
   │ この銘柄はどうしますか？            │
   ├─────────────────────────────────────┤
   │ ○ 💰 プラン通りに買った             │
   │   → 提案された株数・価格で記録      │
   │                                     │
   │ ○ 📝 違う条件で買った               │
   │   → 実際の株数・価格・日付を入力    │
   │                                     │
   │ ○ 📌 マイ銘柄に追加だけする         │
   │   → 購入記録なしで追加              │
   │   → 後から購入記録を追加可能        │
   │                                     │
   │ ○ ⏭️ スキップ                       │
   │   → 何もしない                      │
   └─────────────────────────────────────┘
```

### UIフロー詳細

#### ステップ1: 投資スタイル診断（変更なし）

```
┌─────────────────────────────────────────┐
│ あなたの投資スタイルを教えてください    │
├─────────────────────────────────────────┤
│ 投資に使える予算は？                    │
│ ○ 5万円                                 │
│ ○ 10万円                                │
│ ○ 30万円                                │
│                                         │
│ 投資期間は？                            │
│ ○ 短期（1年未満）                       │
│ ○ 中期（1-5年）                         │
│ ○ 長期（5年以上）                       │
│                                         │
│ [ 診断する ]                            │
└─────────────────────────────────────────┘
```

#### ステップ2: AIの提案（変更なし - むしろ強化）

```
┌─────────────────────────────────────────┐
│ 🤖 あなたにおすすめの投資プラン         │
├─────────────────────────────────────────┤
│                                         │
│ 予算10万円で4銘柄に分散投資             │
│                                         │
│ ┌───────────────────────────────────┐  │
│ │ トヨタ自動車 (7203)               │  │
│ │ 10株 × 2,500円 = 25,000円         │  │
│ │ 成長性 ★★★★☆                    │  │
│ └───────────────────────────────────┘  │
│                                         │
│ ┌───────────────────────────────────┐  │
│ │ ソニーG (6758)                    │  │
│ │ 2株 × 12,000円 = 24,000円         │  │
│ │ 成長性 ★★★★★                    │  │
│ └───────────────────────────────────┘  │
│                                         │
│ ┌───────────────────────────────────┐  │
│ │ 三菱UFJ (8306)                    │  │
│ │ 20株 × 1,200円 = 24,000円         │  │
│ │ 安定性 ★★★★☆                    │  │
│ └───────────────────────────────────┘  │
│                                         │
│ ┌───────────────────────────────────┐  │
│ │ NTT (9432)                        │  │
│ │ 100株 × 150円 = 15,000円          │  │
│ │ 配当性 ★★★★☆                    │  │
│ └───────────────────────────────────┘  │
│                                         │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━          │
│ 合計投資額: 88,000円                    │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━          │
│                                         │
│ [ このプランで始める ]                  │
│                                         │
└─────────────────────────────────────────┘
```

#### ステップ3: 各銘柄の状態を確認（新設計）

```
┌─────────────────────────────────────────┐
│ おすすめ銘柄 (1/4)                      │
├─────────────────────────────────────────┤
│                                         │
│  【トヨタ自動車 (7203)】                │
│  おすすめ: 10株 × 2,500円 = 25,000円   │
│                                         │
│  📊 初心者スコア: ★★★★☆               │
│  📈 成長性が高く、安定した業績です      │
│                                         │
│  この銘柄はどうしますか？               │
│                                         │
│  ┌───────────────────────────────────┐  │
│  │ 💰 プラン通りに買った             │  │
│  │ 10株 × 2,500円で記録します        │  │
│  └───────────────────────────────────┘  │
│                                         │
│  ┌───────────────────────────────────┐  │
│  │ 📝 違う条件で買った               │  │
│  │ 実際の購入内容を入力します        │  │
│  └───────────────────────────────────┘  │
│                                         │
│  ┌───────────────────────────────────┐  │
│  │ 📌 マイ銘柄に追加だけする         │  │
│  │ 購入記録なしで追加                │  │
│  │ (後から購入記録を追加できます)    │  │
│  └───────────────────────────────────┘  │
│                                         │
│  [ ⏭️ スキップ ]                        │
│                                         │
└─────────────────────────────────────────┘
```

#### 「💰 プラン通りに買った」を選択した場合

```
┌─────────────────────────────────────────┐
│                                         │
│  ✅ マイ銘柄に追加しました！            │
│                                         │
│  【トヨタ自動車】                       │
│  10株 × 2,500円 = 25,000円              │
│                                         │
│  購入日を入力してください（任意）       │
│  ┌──────────┐                          │
│  │ 今日      │ ← デフォルト            │
│  └──────────┘                          │
│                                         │
│  [ 次の銘柄へ ]                         │
│                                         │
└─────────────────────────────────────────┘
```

#### 「📝 違う条件で買った」を選択した場合

```
┌─────────────────────────────────────────┐
│ 実際の購入内容を入力                    │
├─────────────────────────────────────────┤
│                                         │
│  【トヨタ自動車 (7203)】                │
│  (おすすめは 10株 × 2,500円)            │
│                                         │
│  いつ買いましたか？                     │
│  ┌──────────┐                          │
│  │ 2024/01/15│                         │
│  └──────────┘                          │
│                                         │
│  何株買いましたか？                     │
│  ┌──────────┐                          │
│  │ 15       │ 株                       │
│  └──────────┘                          │
│                                         │
│  いくらで買いましたか？                 │
│  ┌──────────┐                          │
│  │ 2,400    │ 円                       │
│  └──────────┘                          │
│                                         │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━          │
│  購入金額: 36,000円                     │
│  現在評価額: 37,500円                   │
│  損益: +1,500円 (+4.2%) 📈              │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━          │
│                                         │
│  [ 追加する ]  [ キャンセル ]           │
│                                         │
└─────────────────────────────────────────┘
```

#### 「📌 マイ銘柄に追加だけする」を選択した場合

```
┌─────────────────────────────────────────┐
│                                         │
│  ✅ マイ銘柄に追加しました！            │
│                                         │
│  【トヨタ自動車】                       │
│  現在価格: 2,500円                      │
│                                         │
│  購入記録はまだありません。             │
│  ダッシュボードから価格をチェックして、  │
│  買ったら「購入記録を追加」してください│
│                                         │
│  [ 次の銘柄へ ]                         │
│                                         │
└─────────────────────────────────────────┘
```

#### 最後の画面

```
┌─────────────────────────────────────────┐
│ 🎉 準備完了！                           │
├─────────────────────────────────────────┤
│                                         │
│  マイ銘柄 (4銘柄登録)                   │
│                                         │
│  💰 トヨタ自動車                        │
│     10株 @2,500円 (保有中)              │
│                                         │
│  💰 ソニーG                             │
│     3株 @11,800円 (保有中)              │
│                                         │
│  📌 三菱UFJ                             │
│     購入記録なし                        │
│                                         │
│  📌 NTT                                 │
│     購入記録なし                        │
│                                         │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━          │
│                                         │
│  投資済み: 60,400円 / 予算 100,000円    │
│                                         │
│  🤖 三菱UFJとNTTはマイ銘柄に登録済み    │
│  です。買ったら購入記録を追加しましょう│
│                                         │
│  [ ダッシュボードへ ]                   │
│                                         │
└─────────────────────────────────────────┘
```

**ポイント:**
- ✅ AIの具体的な提案は維持（何を・何株・いくら）
- ✅ 提案通りに買った場合はワンタップで記録
- ✅ 違う条件で買った場合は詳細入力
- ✅ まだ買ってない場合は購入記録なしで追加
- ✅ 全部スキップも可能
- ❌ 「実際に購入/シミュレーション/ウォッチリスト」という言葉は使わない

### シミュレーション機能について

**UIでは「シミュレーション」という言葉を使わない**が、機能としては存在する。

#### 実質的なシミュレーション利用

ユーザーは自由に購入記録を追加できるため、以下のような使い方が可能：

```
【実際に買った場合】
トヨタ自動車
├─ 購入: 10株 @2,500円 (2024/01/15)
└─ 実際の証券口座で購入済み

【シミュレーションとして使う場合】
ソニーG
├─ 購入: 2株 @12,000円 (2024/01/15)
└─ 実際には買ってないが、試しに記録してみた

【どちらか自分でもわからない場合】
三菱UFJ
├─ 購入: 20株 @1,200円 (2024/01/15)
└─ アプリ上では同じように損益計算される
```

**重要:**
- アプリは証券口座と連携していない
- すべてユーザーの自己申告
- 「実際に買った」か「シミュレーション」かは、ユーザーの心の中の問題
- アプリ側では区別しない（区別する必要がない）

#### ユーザーへの説明

ダッシュボードのヘルプやFAQで以下のように説明：

```
Q: 実際に買ってなくても記録できますか？

A: はい、できます。Stock Buddyは証券口座とは連携していないため、
   「買ったつもり」で記録して、シミュレーションとして使うこともできます。
   実際に買ったかどうかは、あなたが覚えておけば大丈夫です。

Q: 実際に買った銘柄と、シミュレーションを区別できますか？

A: 現在は区別していません。必要であれば「メモ」機能を使って
   「実際に購入」「シミュレーション」などと自分で記録できます。
```

#### メモ機能の活用

```typescript
model MyStock {
  // ...
  note  String?  // 「実際に購入」「シミュレーション」などユーザーが自由に記入
}
```

ユーザーが自分で区別したい場合は、メモ欄に書いておける。

## 移行戦略

### フェーズ1: データモデル準備（破壊的変更なし）

1. `MyStock`モデルを新規作成
2. `Transaction`モデルを新規作成
3. 既存の`PortfolioStock`と`Watchlist`から`MyStock`へのデータ移行スクリプト作成
4. マイグレーション実行

```sql
-- MyStockテーブルを作成
CREATE TABLE "MyStock" (...);

-- 既存のPortfolioStockからデータを移行
INSERT INTO "MyStock" (userId, stockId, hasPurchaseRecord, quantity, averagePrice, ...)
SELECT
  p.userId,
  ps.stockId,
  TRUE, -- 購入記録あり
  ps.quantity,
  ps.averagePrice,
  ...
FROM "PortfolioStock" ps
JOIN "Portfolio" p ON ps.portfolioId = p.id;

-- 既存のWatchlistからデータを移行
INSERT INTO "MyStock" (userId, stockId, hasPurchaseRecord, targetPrice, targetCondition, priceAlert, ...)
SELECT
  userId,
  stockId,
  FALSE, -- 購入記録なし
  targetPrice,
  targetCondition,
  priceAlert,
  ...
FROM "Watchlist"
WHERE NOT EXISTS (
  -- 既にPortfolioStockとして登録されている場合は重複を避ける
  SELECT 1 FROM "MyStock" ms
  WHERE ms.userId = "Watchlist".userId
  AND ms.stockId = "Watchlist".stockId
);

-- Transactionデータを移行
INSERT INTO "Transaction" (myStockId, type, quantity, price, date, ...)
SELECT
  ms.id,
  'buy',
  t.quantity,
  t.price,
  t.date,
  ...
FROM "Transaction" t
JOIN "PortfolioStock" ps ON t.portfolioStockId = ps.id
JOIN "Portfolio" p ON ps.portfolioId = p.id
JOIN "MyStock" ms ON ms.userId = p.userId AND ms.stockId = ps.stockId;
```

### フェーズ2: UI更新

1. 新しい「マイ銘柄」画面を作成
2. API routesを新モデルに対応
3. オンボーディングを更新

### フェーズ3: クリーンアップ

1. 旧モデル（Portfolio, PortfolioStock, Watchlist）を削除
2. 不要なAPIルートを削除

## メリット

### ユーザー視点

1. **シンプル**
   - タブ切り替え不要
   - 1画面で全て管理

2. **柔軟**
   - 買ってなくても追加できる（価格監視）
   - 買ったつもりで記録できる（シミュレーション）
   - 実際に買った銘柄も同じように記録できる

3. **段階的な学習**
   - 最初は価格だけ見る
   - 慣れたら購入記録を追加
   - さらに慣れたら複数トランザクションで平均取得単価を管理

### 開発・保守視点

1. **コードの簡素化**
   - モデルが3つから1つに
   - 条件分岐が減る

2. **拡張性**
   - 将来的に証券API連携も可能
   - 売却機能の追加が容易

3. **一貫性**
   - すべての銘柄が同じデータ構造
   - バグが減る

## リスクと対策

### リスク1: 既存ユーザーのデータ移行

**対策:**
- マイグレーションスクリプトで自動変換
- 移行前にバックアップ
- ステージング環境で十分にテスト

### リスク2: ユーザーの混乱

**対策:**
- リリース時にお知らせ表示
- チュートリアル更新
- 「シンプルになりました」というポジティブなメッセージ

### リスク3: 開発規模が大きい

**対策:**
- フェーズ分けして段階的にリリース
- フェーズ1で新旧並行稼働も検討

## 次のステップ

1. この設計をレビュー・承認
2. 詳細なタスク分解
3. マイグレーションスクリプト作成
4. フェーズ1実装開始
