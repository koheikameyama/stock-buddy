# おすすめ銘柄スコアリングロジック

## 概要

ユーザーごとのAIおすすめ銘柄生成において、投資スタイル（期間×リスク許容度）に基づいたスコアリングで銘柄を絞り込む。

## 対象スクリプト

- `scripts/github-actions/generate_user_recommendations.py`

## 処理フロー

```
1. 全銘柄取得（株価データあり）
     ↓
2. 予算フィルタ（100株購入可能な銘柄のみ）
     ↓
3. 投資スタイルに基づいてスコア計算
     ↓
4. スコア順にソート
     ↓
5. セクター分散（各セクター最大5銘柄）
     ↓
6. 上位30銘柄をAIに渡す
     ↓
7. AIが3銘柄を選定
```

## スコアリング指標

| 指標 | 説明 | 用途 |
|------|------|------|
| `weekChangeRate` | 週間変動率（%） | 短期モメンタム |
| `volumeRatio` | 出来高比率（直近3日/過去平均） | 注目度・話題性 |
| `volatility` | 30日間ボラティリティ（%） | リスク指標 |
| `marketCap` | 時価総額（億円） | 安定性・信頼性 |

## 投資スタイル別スコア配分

### 短期投資

| リスク | weekChangeRate | volumeRatio | volatility | marketCap |
|--------|----------------|-------------|------------|-----------|
| 高い   | 40%            | 30%         | 20%        | 10%       |
| 普通   | 35%            | 25%         | 15%        | 25%       |
| 低い   | 25%            | 20%         | 15%*       | 40%       |

### 中期投資

| リスク | weekChangeRate | volumeRatio | volatility | marketCap |
|--------|----------------|-------------|------------|-----------|
| 高い   | 30%            | 25%         | 20%        | 25%       |
| 普通   | 25%            | 25%         | 25%        | 25%       |
| 低い   | 15%            | 15%         | 30%*       | 40%       |

### 長期投資

| リスク | weekChangeRate | volumeRatio | volatility | marketCap |
|--------|----------------|-------------|------------|-----------|
| 高い   | 20%            | 20%         | 25%        | 35%       |
| 普通   | 15%            | 15%         | 30%*       | 40%       |
| 低い   | 10%            | 10%         | 35%*       | 45%       |

*: volatilityは低リスク志向の場合、低い方が高スコアになるよう反転

## スコア計算ロジック

### 1. 正規化（Min-Max Normalization）

各指標を0-100の範囲に正規化する。

```python
score = (value - min_value) / (max_value - min_value) * 100
```

- 値がない銘柄は中間値（50）を使用
- volatilityは低リスク志向の場合に反転（100 - score）

### 2. 重み付け加算

```python
total_score = Σ (normalized_value × weight / 100)
```

例: 短期×高リスクの場合
```
total = weekChangeRate × 0.40
      + volumeRatio × 0.30
      + volatility × 0.20
      + marketCap × 0.10
```

### 3. ソートと分散

1. スコア順（降順）にソート
2. 各セクターから最大5銘柄まで選択
3. 上位30銘柄をAIに渡す

## 設計思想

### なぜ出来高順ではなくスコアリングか

**旧ロジックの問題点:**
- 出来高順にソートしていたため大型株に偏りがち
- ユーザーの投資スタイルが絞り込み段階で反映されていない
- 週間変動率などの指標を取得しているが活用していない

**新ロジックの利点:**
- ユーザーの投資スタイルに合った銘柄が上位に来る
- 短期×高リスクなら「今動いている銘柄」が上位
- 長期×低リスクなら「安定した大型株」が上位

### volatilityの反転について

- 高リスク志向: 高ボラティリティ = 高スコア（値動きが大きい方が良い）
- 低リスク志向: 低ボラティリティ = 高スコア（安定している方が良い）

反転条件:
- `risk == "low"`
- `risk == "medium" && period == "long"`

## 関連ドキュメント

- [銘柄選定基準](./STOCK_SELECTION_CRITERIA.md) - DBに登録する銘柄の選定基準
- [注目銘柄設計](./plans/2026-02-03-daily-featured-stocks-design.md) - DailyFeaturedStockの設計

---

**最終更新**: 2026-02-13
**関連タスク**: KOH-133
