# 銘柄詳細 仕様書

## 概要

個別銘柄の詳細情報ページです。チャート、テクニカル分析、財務指標、ニュースをタブ形式で表示します。

**ページパス**: `/stocks/[stockId]`

## 画面構成

### ヘッダー

- 銘柄名、証券コード、市場、セクター
- 上場廃止の場合は警告表示

### 現在価格カード

- リアルタイム価格（`useStockPrice` フックで自動更新）
- 52週高値/安値
- アクションボタン: ウォッチリスト追加 / ポートフォリオ追加 / 追跡追加

### 推奨情報（該当する場合）

- パーソナルAI推奨（ユーザーの日次おすすめから）
- 注目銘柄情報（全体のおすすめから）
- カテゴリバッジ: 急騰 / 安定 / 話題
- 推奨理由テキスト

### タブ

#### チャートタブ

- ローソク足チャート（期間選択: 1ヶ月 / 3ヶ月 / 1年）
- OHLCV データ表示

#### テクニカル分析タブ

**テクニカル指標**:

| 指標 | 説明 | 判定基準 |
|------|------|----------|
| RSI（14期間） | 相対力指数 | > 70: 買われすぎ / < 30: 売られすぎ |
| MACD | 移動平均収束拡散 | MACDライン、シグナルライン、ヒストグラム |
| 移動平均乖離率 | 25日MAからの乖離 | > +20%: 過熱 / < -20%: 売られすぎ |

**チャートパターン検出**:

買いシグナル（強度順）:

| パターン | 強度 | 信頼度 | 説明 |
|----------|------|--------|------|
| 逆三尊 | 95 | 0.85 | 3つの谷、中央が最も深い |
| ダブルボトム | 90 | 0.80 | W型、2つの等しい底値 |
| 上昇トライアングル | 85 | 0.75 | 高値横ばい、安値切り上げ |
| トリプルボトム | 88 | 0.78 | 3つの等しい底値 |
| 上昇フラッグ | 75 | 0.65 | 急上昇後の下向き保ち合い |

売りシグナル（強度順）:

| パターン | 強度 | 信頼度 | 説明 |
|----------|------|--------|------|
| ダブルトップ | 90 | 0.80 | M型、2つの等しい高値 |
| 三尊 | 95 | 0.85 | 3つの山、中央が最も高い |
| 下降トライアングル | 85 | 0.75 | 安値横ばい、高値切り下げ |
| 下降フラッグ | 75 | 0.65 | 急下落後の上向き保ち合い |

中立シグナル:

| パターン | 説明 |
|----------|------|
| ボックスレンジ | 一定範囲内で推移 |
| 三角保ち合い | 高値切り下げ・安値切り上げ、収束 |

**トレンドライン分析**:

安値同士（サポートライン）・高値同士（レジスタンスライン）を結んだ直線を自動検出し、価格の方向性を判定する。

| 項目 | 説明 |
|------|------|
| サポートライン | 安値のトラフを結ぶ下値支持線。割り込むと下落加速の傾向 |
| レジスタンスライン | 高値のピークを結ぶ上値抵抗線。突破すると上昇加速の傾向 |
| トレンド方向 | 上昇トレンド / 下降トレンド / 横ばい |
| ブレイクアウト/ブレイクダウン | 現在価格がトレンドラインを突破/割り込んだかを検出 |

検出アルゴリズム:
- ローカル極値（ピーク/トラフ）をウィンドウサイズ3で検出
- すべてのペアに対してラインを引き、接触回数・逸脱回数で品質評価
- 接触許容幅: 2%、最小接触回数: 2回、最小スパン: データの30%以上
- 閾値は `lib/constants.ts` の `TRENDLINE` で一元管理

表示:
- チャートタブ: 破線でサポートライン（緑）・レジスタンスライン（赤）を描画（トグルで表示/非表示切替可能）
- テクニカル分析タブ: トレンド方向、各ラインの詳細（方向・接触回数・予測価格・ブレイク状態）を表示
- AI分析: プロンプトコンテキストにトレンドライン情報を含めて判断材料として使用

#### ニュースタブ

- 直近14日間の関連ニュース（最大5件）
- センチメント表示（positive / negative / neutral）

#### 詳細タブ

**財務指標**:

| 指標 | 説明 |
|------|------|
| PBR | 株価純資産倍率 |
| PER | 株価収益率 |
| ROE | 自己資本利益率 |
| 営業CF | 営業キャッシュフロー |
| フリーCF | フリーキャッシュフロー |
| 配当利回り | 年間配当/株価 |
| 時価総額 | 発行株数×株価 |
| EPS | 1株当たり利益 |
| 売上高 / 純利益 | 直近通期 |
| 売上高成長率 / 純利益成長率 | 前年比 |
| 次回決算日 | カウントダウンバッジ付き |

## スコアリングロジック

### おすすめ銘柄スコアリング

**入力データ**: 週間変化率、出来高比率、ボラティリティ、時価総額、黒字/赤字、MA乖離率、セクタートレンド

**投資スタイル別重み配分**:

| 指標 | 積極的 | バランス | 保守的 |
|------|--------|----------|--------|
| モメンタム | 35% | 25% | 15% |
| 出来高 | 30% | 25% | 15% |
| ボラティリティ | 20% | 25% | 30%（逆相関） |
| 時価総額 | 15% | 25% | 40% |

**ペナルティ**:

| 条件 | ペナルティ |
|------|----------|
| 急騰（+20%以上） | -10〜-20 |
| スパイク（+30%以上） | -20 |
| 赤字+高ボラ（>50%） | -10/-20/-30（スタイル別） |
| 決算未定 | -5 |
| MA過熱（+20%以上） | -5（積極的はスキップ） |
| MA割安（-20%以下、黒字、低ボラ） | +5 ボーナス |

**セクター分散**: 1セクター最大5銘柄

**予算フィルタ**: 100株単位で購入可能な銘柄のみ

## API仕様

### 株価関連

#### `GET /api/stocks/prices`

複数銘柄の株価を一括取得。

**クエリパラメータ**: `tickers=7203.T,8306.T,...`

#### `GET /api/stocks/search?q={query}`

銘柄検索（証券コード/銘柄名）。リアルタイム株価付き。

### 分析関連

#### `GET /api/stocks/[stockId]/historical-prices?period={1m|3m|1y}`

OHLCV + RSI + MACD データ。

**レスポンス**:
```json
{
  "data": [
    {
      "date": "2026-02-21",
      "open": 2500,
      "high": 2550,
      "low": 2480,
      "close": 2530,
      "volume": 1500000,
      "rsi": 55.3,
      "macd": 12.5,
      "macdSignal": 10.2,
      "macdHistogram": 2.3
    }
  ],
  "summary": {
    "dateRange": "2026-01-22 ~ 2026-02-21",
    "dataPoints": 22
  }
}
```

#### `GET /api/stocks/[stockId]/purchase-recommendation`

最新の購入判断を取得（7日以内のもの）。

#### `POST /api/stocks/[stockId]/purchase-recommendation`

新しい購入判断を生成。

#### `POST /api/stocks/[stockId]/simulated-portfolio-analysis`

仮保有（100株）での分析シミュレーション。

#### `POST /api/stocks/[stockId]/mover-analysis`

日次株価変動の原因分析。

#### `GET /api/stocks/[stockId]/news`

関連ニュース取得（14日分、最大5件）。

## 関連ファイル

- `app/stocks/[stockId]/page.tsx` - ページエントリ
- `app/stocks/[stockId]/StockDetailClient.tsx` - クライアントコンポーネント
- `app/api/stocks/route.ts` - 銘柄検索 API
- `app/api/stocks/prices/route.ts` - 株価取得 API
- `lib/stock-fetcher.ts` - 株価データ取得
- `lib/recommendation-scoring.ts` - スコアリングロジック
- `lib/chart-patterns.ts` - チャートパターン検出
- `lib/stock-safety-rules.ts` - 安全ルール
