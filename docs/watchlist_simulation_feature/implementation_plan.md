# 実装計画 - ウォッチリスト詳細でのポートフォリオ分析シミュレーション

ウォッチリスト詳細画面にて、「今の価格で100株買った場合」にどのようなポートフォリオ分析（売買判断、価格予測など）が行われるかをシミュレートする機能を追加します。

## ユーザーレビューが必要な項目

> [!IMPORTANT]
> シミュレーション結果はデータベースに保存されません。ページをリロードするとシミュレーション結果は消えます。

## 変更内容

### バックエンド (lib/portfolio-analysis-core.ts)

シミュレーション用の関数 `executeSimulatedPortfolioAnalysis` を追加します。
また、既存の `executePortfolioAnalysis` 内のプロンプト生成ロジックを共通関数 `buildPortfolioAnalysisPrompt` として抽出します。

共通化のメリット：

- ポートフォリオ分析とシミュレーションでAIの判断基準を完全に統一できます。
- プロンプトの改善が両方の機能に自動的に反映されます。

シミュレーション関数（`executeSimulatedPortfolioAnalysis`）の詳細は以下の通りです：

- データベースから `PortfolioStock` を取得せず、引数で与えられた銘柄ID、数量、平均単価を使用します。
- 実行結果をデータベース（`PortfolioStock` や `StockAnalysis` テーブル）に保存しません。
- 信頼度やトレンド情報を含む、フロントエンドの表示に必要な全てのデータを返却します。

### API (app/api/stocks/[stockId]/simulated-portfolio-analysis/route.ts) [NEW]

シミュレーション用のPOSTエンドポイントを作成します。

- 銘柄IDをパスパラメータで受け取ります。
- ユーザーID、数量（100固定予定）、平均単価（現在価格を想定）をもとに分析を実行します。

### フロントエンド (app/components/StockAnalysisCard.tsx)

シミュレーションモードをサポートするように修正します。

- `isSimulation` などのプロパティを追加します。
- シミュレーションモード時は、通常のエンドポイントではなくシミュレーション用エンドポイントを呼び出すように変更します。
- 表示内容は既存の `StockAnalysisCard` のUIを活用します。

### フロントエンド (app/my-stocks/[id]/MyStockDetailClient.tsx)

ウォッチリスト表示セクションにシミュレーション開始のUIを追加します。

- 「100株買った場合をシミュレート」といったボタンを追加します。
- ボタン押下時に `StockAnalysisCard` をシミュレーションモードで表示するか、既存のカードを差し替えます。

## 検証計画

### 自動テスト / 手動検証

1. ウォッチリスト詳細ページを開く。
2. 「100株買った場合をシミュレート」ボタンが表示されていることを確認。
3. ボタンをクリックし、AI分析（売買判断、価格予測）が表示されることを確認。
4. ページをリロードし、シミュレーション結果が消え、元の状態（分析なし、または過去の汎用分析）に戻ることを確認。
5. データベースを確認し、シミュレーション実行によって `PortfolioStock` 等に新しいレコードが作成されていないことを確認。
