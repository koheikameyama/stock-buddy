# 銘柄ティッカーサフィックスの自動判別と取得効率の最適化

## 変更の概要

銘柄マスタの `tickerCode` に一律で `.T` を付与する以前の設計を改め、市場を自動判別して適切なサフィックス（`.T`, `.NG` など）を付けて保存する方針に完全に移行しました。また、バルク取得の導入により判別と株価取得を大幅に高速化し、実在しない銘柄の登録を防ぐガードを実装しました。

## 実装の詳細

### 1. 市場判別とバルク取得の最適化

- `scripts/python/fetch_stock_prices.py` を刷新し、`yf.Tickers().history()` を活用して複数の候補（`.T`, `.NG`）を一括で確認します。
- これにより、個別の `.info` 呼び出しに比べてネットワーク負荷と待ち時間を劇的に削減しました。

### 2. 銘柄登録・検索の強化

- **登録ガード**: `app/api/stock-requests/route.ts` にて、市場判別でヒットしなかった銘柄（実在しない、またはYahoo Financeで取得不可）は登録をブロックするようにしました。
- **検索マッピング**: `app/api/stocks/search/route.ts` にて、サフィックス付きコードと取得結果を正しく照合するように調整しました。

### 3. バッチ同期の堅牢化

- `scripts/jpx/sync_stock_master_from_jpx.py` および `scrape_stocks.py` に Yahoo Finance での存在チェックステップを追加しました。
- JPXのリストに含まれる銘柄であっても、データが取得できないものはDB保存をスキップし、取得可能なものは正しいサフィックスへと自動変換します。

### 4. 既存データのクリーンアップ

- 現在、DB内の既存銘柄全てをスキャンするマイグレーションスクリプトを実行中です：
  - 数字コード銘柄への正しいサフィックス付与。
  - 取得不可能な古い銘柄や不正データのDBからの削除。

## 検証結果

- 東証 (`.T`)、名証 (`.NG`)、米国株 (サフィックス無し) のそれぞれで正しい市場判別と価格取得ができることを確認済みです。
- クリーンアップスクリプトにより、DB内の無効なレコードが順次削除されていることを確認しています。
