# OpenAI API 使用量モニタリング

## 概要

OpenAI APIのコストを管理し、予算超過を防ぐための運用フロー。

**監視対象**: Stock Buddyプロジェクト専用（`proj_Pnbj8J65ZaUns8dBvvki1qTG`）

## 予算設定

- **月次予算**: $10（約¥1,480）
- **アラート閾値**:
  - 50%到達: $5（約¥740）
  - 80%到達: $8（約¥1,184）
  - 100%到達: $10（約¥1,480）

## 日次チェック手順

### 毎日 10:00 JST

GitHub Actionsが自動的に実行され、以下を行います：

1. **OpenAI Costs APIから使用量を取得**
   - Stock Buddyプロジェクト専用の使用量を取得
   - 今月の累計コストを計算

2. **予算進捗の確認**
   ```
   現在の使用量 / 月次予算 = 使用率

   例:
   $5 / $10 = 50%
   ```

3. **Slack通知**
   - 毎日の使用量レポートをSlackに送信
   - 閾値到達時は自動アラート

4. **必要に応じてアクション**
   - **50%未満**: 問題なし（日次レポートのみ）
   - **50-80%**: 注意深く監視（情報通知）
   - **80%以上**: 緊急対応が必要（警告通知）
   - **100%超過**: 即座に対応（緊急アラート + GitHub Issue自動作成）

## アラート対応フロー

### 80%到達時（$8）

1. **原因調査**
   - どのAPIエンドポイントで使用量が多いか確認
   - ユーザー数の増加が原因か確認

2. **対策検討**
   - AI分析頻度を下げる（毎日→週1回）
   - プロンプトを最適化して使用トークンを削減

3. **Linearタスク作成**
   - 緊急対応タスクとして登録

### 100%到達時（$10）

1. **即座に対応**
   - AI分析を一時停止（オプション）
   - ユーザーに通知

2. **追加予算の検討**
   - 予算を$20に増額するか判断
   - 収益とのバランスを確認

## 自動監視の仕組み

### GitHub Actions

- **ワークフロー**: `.github/workflows/check-openai-usage.yml`
- **スクリプト**: `scripts/github-actions/check_openai_usage.py`
- **スケジュール**: 毎日 10:00 JST (01:00 UTC)
- **手動実行**: GitHub Actionsから随時可能

### Slack通知

- 毎日の使用量レポート
- 閾値到達時の自動アラート
- アラートレベルに応じた色分け
  - 緑: 通常範囲内
  - 黄: 50%到達
  - 赤: 80%以上

## 関連ドキュメント

- [収益化戦略](./monetization-strategy.md)
- [コスト分析](./cost-analysis.md)
- [Linear KOH-100](https://linear.app/koheikameyama/issue/KOH-100)

## 改訂履歴

| 日付 | 内容 |
|------|------|
| 2026-01-31 | 初版作成 |
