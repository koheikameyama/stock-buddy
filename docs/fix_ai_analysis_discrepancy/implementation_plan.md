# 実装計画 - AI分析の判断不一致の修正

## 課題の概要

同じ銘柄、同じタイミングにおいて、「ウォッチリスト分析（購入判断）」と「ポートフォリオ分析（売買判断）」で結果が矛盾する（片方が買い、片方が売り）という事象が発生している。これは、特にウォッチリスト分析側がテクニカルな悪化（下落シグナル）を過小評価し、ファンダメンタルズの良さを過大評価していることに起因する。

## 修正方針

1. **ウォッチリスト分析プロンプトの強化**: `lib/purchase-recommendation-core.ts` のプロンプトを修正し、ポートフォリオ分析と同等の「リスク回避的なテクニカル評価基準」を導入する。
2. **「落ちるナイフ」回避ロジックの厳格化**: 強い売りシグナル（大陰線、出来高を伴う下落、相対的な弱さ）が出ている場合は、どれだけ成長性が高くても "buy" を避け、"stay"（様子見）を推奨するように強制する。
3. **共通分析ロジックの共有**: 出来高分析や相対強度分析の結果をウォッチリスト分析側でもより詳しくプロンプトに含める。

## 具体的な変更内容

### 1. `lib/purchase-recommendation-core.ts`

- プロンプトの【モメンタム判断】セクションを強化。
- プロンプトに【相対強度・出来高を考慮した下落の性質判断】および【損切りに相当する「強い見送り（avoid）」の判断指針】を追加（`portfolio-analysis-core.ts` と同等の基準）。
- コード側で、出来高分析 (`buildVolumeAnalysisContext`) と相対強度分析 (`buildRelativeStrengthContext`) を追加してプロンプトに注入する。

### 2. `lib/stock-analysis-context.ts` (必要に応じて)

- 両分析で共通して使用するプロンプト定数やビルダーを整理。

## 完了条件

- ウォッチリスト分析が、強いテクニカル悪化局面において「成り行き購入OK」を出さず、適切に「様子見（stay）」または「見送り（avoid）」を推奨するようになること。
- 両分析間で、同じテクニカルデータに対して矛盾しない一貫した評価が下されること。
