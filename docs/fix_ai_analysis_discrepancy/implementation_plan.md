# 実装計画 - AI分析の判断不一致の修正

## 課題の概要

同じ銘柄、同じタイミングにおいて、「ウォッチリスト分析（購入判断）」と「ポートフォリオ分析（売買判断）」で結果が矛盾する（片方が買い、片方が売り）という事象が発生している。これは、特にウォッチリスト分析側がテクニカルな悪化（下落シグナル）を過小評価し、ファンダメンタルズの良さを過大評価していることに起因する。

## 修正方針

1. **ウォッチリスト分析プロンプトの強化**: `lib/purchase-recommendation-core.ts` のプロンプトを修正し、ポートフォリオ分析と同等の「リスク回避的なテクニカル評価基準」を導入する。
2. **「落ちるナイフ」回避ロジックの厳格化**: 強い売りシグナル（大陰線、出来高を伴う下落、相対的な弱さ）が出ている場合は、どれだけ成長性が高くても "buy" を避け、"stay"（様子見）を推奨するように強制する。
3. **テクニカル指標による強制補正（Hard Override）**: プロンプトだけでなく、TypeScriptコード側で「ローソク足シグナルが強い売り」などの場合に、強制的に `stay`（様子見）へ変更するロジックを導入する。
4. **キャッシュされた予測データの扱い修正**: バッチ等で生成された「価格帯予測」が上昇となっていても、リアルタイムのテクニカルが悪化している場合は、リアルタイム側を優先して「買い」を抑制するようにプロンプトとロジックを調整する。

## 具体的な変更内容

### 1. `lib/purchase-recommendation-core.ts`

- プロンプトの【モメンタム判断】セクションを強化。
- プロンプトに、キャッシュされた予測データとリアルタイムデータが矛盾する場合の優先順位（リアルタイム優先・安全性優先）を追記。
- コード側で `generatePatternsResponse` または `getCombinedSignal` を使用してテクニカル総合スコアを取得し、強い売りシグナル（sell）が出ている場合は、AIの回答に関わらず `recommendation` を `stay` に書き換える。

### 2. `lib/stock-analysis-context.ts` (必要に応じて)

- 両分析で共通して使用するプロンプト定数やビルダーを整理。

## 完了条件

- ウォッチリスト分析が、強いテクニカル悪化局面において「成り行き購入OK」を出さず、適切に「様子見（stay）」または「見送り（avoid）」を推奨するようになること。
- 両分析間で、同じテクニカルデータに対して矛盾しない一貫した評価が下されること。
