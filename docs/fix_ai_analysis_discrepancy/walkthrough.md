# 修正内容の確認 (Walkthrough)

## 概要

「買い推奨」直後に「売却」判定が出る際の不信感を解消するため、AIが自身の判断変化を誠実に説明し、システム側でも「重大な理由」がある場合のみ売却を許容するようロジックを改善しました。

## 変更内容

### [portfolio-analysis-core.ts](file:///Users/kouheikameyama/development/stock-buddy/lib/portfolio-analysis-core.ts)

- **プロンプトの強化**:
  - 購入直後の売却判定において、前回の「買い」判断との整合性を説明する `reconciliationMessage` フィールドを追加。
  - AIに対し、「なぜ判断が変わったのか」を誠実に説明するよう指示を強化。
- **柔軟なガードレール**:
  - `isCriticalChange` フラグを導入。重大な状況変化（決算ミス、地合いの急変等）がある場合のみ、購入直後の売却を許可。
  - 単なるテクニカルな理由（RSIの過熱等）での売却は、システム側で自動的に `hold` へ補正しつつ、AIの分析結果（判断の変化）を補足として表示するように変更。

## 検証結果

- **コード品質**: 不足していた定数 `PORTFOLIO_ANALYSIS` のインポートを修正し、型定義も最新のプロンプト形式に合わせました。
- **ロジックの妥当性**: 「一律禁止」から「理由の重みによる判定」へとシフトしたことで、ユーザーの「まともな理由があるなら売るべき」という意向と、「狼狽売りの防止」を両立させました。

## 今後の展望

- 実際のユーザーの利用状況を観察し、AIが生成する `reconciliationMessage`（釈明メッセージ）の品質をさらに微調整していく予定です。
