# Stock Buddy リフォーカス提案

## 背景

現在のStock Buddyは「投資初心者向け」で「何をいくら買うか」まで提案する設計になっている。しかし、この方向性には以下の課題がある：

- オンボーディングが重い（予算・期間→銘柄数決定→配分計算）
- 「AIが買えと言った」という責任問題
- 初心者がそこまで求めているか不明

---

## 新しい方向性

### ターゲットユーザー

**すでに投資をやっている人**
- 持っている銘柄の情報を効率よく得たい
- 新しい投資機会を見つけたい
- 自分で判断するが、材料が欲しい

### コアバリュー

| 変更前 | 変更後 |
|--------|--------|
| 寄り添う・怖くない | 効率的に情報を得る |
| お任せ感 | 自分で判断する材料を提供 |
| 何を買うか提案 | 注目銘柄を提示（判断は委ねる） |

### 設計思想

**やること**
- 毎日の市場動向を伝える
- 持っている銘柄の分析・未来予測を提供
- 投資スタイルに合った注目銘柄を提示
- 価格アラートで機会を通知

**やらないこと**
- 「これを○株買え」という提案
- ポートフォリオ配分の最適化
- 売買タイミングの指示

---

## 機能の整理

### 残す機能

| 機能 | 説明 | 変更点 |
|------|------|--------|
| 銘柄分析 | 短期/中期/長期のトレンド予測 | そのまま |
| Featured Stocks | 今日の注目銘柄 | カテゴリ別表示（急騰/安定/話題）に変更 |
| マイ銘柄 | 登録した銘柄の一覧・分析 | **ポートフォリオ/ウォッチリスト統合** |
| 価格アラート | 目標価格で通知 | そのまま |
| コーチメッセージ | 毎日の情報提供 | 売買指示→情報提供に変更 |
| 投資スタイル設定 | 短期/中期/長期の選択 | コーチメッセージのトーンに使用 |

### 削除する機能

| 機能 | 理由 |
|------|------|
| シミュレーション | ターゲットが経験者になるため不要 |
| 銘柄数自動決定 | 「いくら買うか」提案の一部 |
| 配分提案 | 「いくら買うか」提案の一部 |
| 予算ベースのオンボーディング | 不要になる |
| ポートフォリオ/ウォッチリストのタブ分け | 統合して「マイ銘柄」に |
| Hot Stocks | Featured Stocksに統合 |

---

## オンボーディングの変更

### 現状

```
1. 予算を入力
2. 投資期間を選択
3. → 銘柄数を自動決定
4. → 配分を計算して提案
5. → 実投資 or シミュレーション or ウォッチリスト
```

### 変更後

```
1. 投資スタイルを選択（短期/中期/長期）
2. → 完了
```

---

## ダッシュボード構成の変更

### 現状

```
ダッシュボード
├─ コーチメッセージ（上部）
├─ Featured Stocks（タブ）
├─ Hot Stocks（タブ）
├─ ポートフォリオ（タブ）
└─ ウォッチリスト（タブ）
```

### 変更後

```
ダッシュボード
├─ マイ銘柄（最上部・デフォルト表示）
│   ├─ 📊 保有中
│   └─ 👀 ウォッチ中
├─ 注目銘柄
│   ├─ 🚀 急騰銘柄
│   ├─ 💎 安定銘柄
│   └─ 📈 今日の話題（X連携）
└─ コーチメッセージ（下部）
```

**表示優先順位の変更理由**:
- ユーザーが最も見たいのは「自分の銘柄」
- 注目銘柄は参考情報として2番目
- コーチメッセージは補助的な位置づけ

**実装方針**:
- ダッシュボードを開くと「マイ銘柄」が最初に表示
- タブではなくスクロール式の縦並び表示
- それぞれのセクションを折りたたみ可能に

---

## コーチメッセージの変更

### 現状

```
「○○を売却検討しましょう」
「○○は買い増しのチャンスです」
「△△が買い時です、ポートフォリオに追加しませんか？」
```

### 変更後

```
「今日の市場: 日経平均+1.2%、半導体セクター好調」
「保有銘柄: ○○が+3%（決算発表控え）、△△は横ばい」
「注目: □□が出来高急増、業績上方修正の観測」
```

アクション指示ではなく、判断材料を提供する。

---

## 期待される効果

1. **開発・運用の簡素化** - 提案ロジックが不要になる
2. **責任範囲の明確化** - 判断はユーザーに委ねる
3. **ユーザー体験の向上** - 必要な情報に素早くアクセス
4. **ターゲット拡大** - 初心者限定→経験者も使える

---

## データアーキテクチャの刷新

### 現状の課題

**問題点**:
- 全銘柄の2年分の株価データをDB保存（データ量が膨大）
- 全銘柄を定期的にAI分析（API料金が高額）
- データ更新が重い
- yfinanceでIPO銘柄が取得できない

**現状の構成**:
```
Stock (銘柄マスタ)
  └─ StockPrice (2年分の株価データ)
      └─ 全銘柄を毎日更新
          └─ 全銘柄をAI分析（高コスト）
```

### 新しいデータアーキテクチャ

**コンセプト**: オンデマンド分析 + 注目銘柄のみDB保存

```
【層1】銘柄マスタ（全銘柄）
  - JPXスクレイピングで取得
  - 銘柄コード、名前、市場区分、業種
  - IPO銘柄も自動取得
  - 株価データは保存しない

【層2】注目銘柄プール
  - Twitter (X) 連携で毎日発見
  - 10-20銘柄程度
  - AI分析結果のみ保存

【層3】ユーザー登録銘柄
  - ポートフォリオ + ウォッチリスト統合
  - ユーザーが登録した銘柄のみ
  - AI分析結果のみ保存
```

### データ取得戦略

| データ種別 | 取得元 | 更新頻度 | 保存期間 |
|-----------|--------|---------|---------|
| 銘柄マスタ | JPX公式サイトスクレイピング | 週1回 | 永続 |
| 株価データ | yfinance API（リアルタイム） | 表示時に取得 | 保存しない |
| 注目銘柄 | Twitter (X) スクレイピング | 毎日 | 1週間 |
| AI分析結果 | OpenAI API | 登録時/毎日 | 永続 |

### データベース設計

```prisma
// 銘柄マスタ（JPXから取得）
model Stock {
  id            String @id @default(cuid())
  tickerCode    String @unique
  name          String
  market        String?  // 東証プライム、グロース等
  sector        String?  // 業種
  beginnerScore Int?     // 初心者向けスコア
  listedDate    DateTime? // 上場日（IPO対応）
}

// 注目銘柄プール（X連携で発見）
model FeaturedStock {
  id        String @id @default(cuid())
  stockId   String
  stock     Stock @relation(fields: [stockId], references: [id])
  date      DateTime @default(now())
  category  String  // "surge" | "stable" | "trending"
  reason    String? // AI分析結果
  score     Float?
  source    String  // "twitter" | "manual"
}

// ユーザーの銘柄（ポートフォリオ + ウォッチリスト統合）
model UserStock {
  id          String @id @default(cuid())
  userId      String
  user        User @relation(fields: [userId], references: [id])
  stockId     String
  stock       Stock @relation(fields: [stockId], references: [id])

  // 数量入力あり → 保有中、なし → ウォッチ中
  quantity    Int?
  averagePrice Float?
  purchaseDate DateTime?

  // AI分析結果
  lastAnalysis DateTime?
  shortTerm   String?  // 短期予測
  mediumTerm  String?  // 中期予測
  longTerm    String?  // 長期予測
}

// 株価データは削除 or キャッシュ用（1週間分のみ）
```

### JPXスクレイピングの実装

**対象サイト**:
- [JPX 上場会社一覧](https://www.jpx.co.jp/listing/co-search/index.html)
- [JPX 新規上場会社情報](https://www.jpx.co.jp/listing/stocks/new/index.html)

**取得データ**:
- 銘柄コード（例: 7203）
- 会社名（例: トヨタ自動車）
- 市場区分（例: プライム）
- 業種（例: 輸送用機器）
- 上場日（IPO銘柄用）

**実装例**:
```python
import requests
from bs4 import BeautifulSoup

def scrape_jpx_stocks():
    """JPXから上場企業リストを取得"""
    url = "https://www.jpx.co.jp/listing/co-search/index.html"
    response = requests.get(url)
    soup = BeautifulSoup(response.content, "html.parser")

    stocks = []
    # スクレイピングロジック
    for row in soup.select("table tr"):
        ticker = row.select_one(".ticker").text
        name = row.select_one(".name").text
        market = row.select_one(".market").text
        sector = row.select_one(".sector").text
        stocks.append({
            "tickerCode": ticker,
            "name": name,
            "market": market,
            "sector": sector
        })

    return stocks
```

### AI料金の削減

**現状**: 全銘柄を毎日分析 → 3,000銘柄 × 1円 = 3,000円/日

**変更後**: 登録銘柄 + 注目銘柄のみ分析
- ユーザー登録銘柄: 平均50銘柄/ユーザー × 100ユーザー = 5,000銘柄
- 重複を除くと実質500銘柄程度
- 注目銘柄: 20銘柄/日

**合計**: 520銘柄 × 1円 = 520円/日 → **約85%削減**

### マイ銘柄（ポートフォリオ/ウォッチリスト統合）

**UI設計**:

```
【マイ銘柄ページ】

🔍 銘柄を追加

─────────────────────
📊 保有中（3銘柄）
─────────────────────
トヨタ自動車 (7203)
  保有数: 100株 | 平均単価: ¥2,500
  現在価格: ¥2,650 (+6.0%)
  📈 短期: 上昇 | 中期: 横ばい | 長期: 上昇

ソニーグループ (6758)
  保有数: 50株 | 平均単価: ¥12,000
  現在価格: ¥11,800 (-1.7%)
  📉 短期: 下落 | 中期: 上昇 | 長期: 上昇

─────────────────────
👀 ウォッチ中（2銘柄）
─────────────────────
任天堂 (7974)
  現在価格: ¥8,200
  📈 短期: 上昇 | 中期: 上昇 | 長期: 横ばい

キオクシア (6600)
  現在価格: ¥1,850
  📊 短期: 横ばい | 中期: 上昇 | 長期: 上昇
```

**実装方針**:
- `quantity`フィールドの有無で「保有中/ウォッチ中」を区別
- データベースは`UserStock`テーブルに統合
- UIで2セクションに分けて表示

### Featured Stocks（注目銘柄）

**カテゴリ別表示**:

```
【注目銘柄ページ】

─────────────────────
🚀 急騰銘柄（3銘柄）
─────────────────────
エヌビディア日本法人 (XXXX)
  +8.5% | 出来高急増
  AI半導体需要で注目

─────────────────────
💎 安定銘柄（3銘柄）
─────────────────────
三菱UFJ (8306)
  配当利回り 4.2%
  長期保有向け

─────────────────────
📈 今日の話題（3銘柄）
─────────────────────
キオクシア (6600)
  Xで1,200件の言及
  IPO注目銘柄
```

**生成ロジック**:
- Twitter (X) で高エンゲージメントツイートから銘柄コード抽出
- yfinanceで株価取得
- AIで分析・カテゴリ分類
- 毎日10-20銘柄を更新

### 期待される効果

1. **コスト削減**: AI料金85%削減（3,000円/日 → 520円/日）
2. **データ量削減**: 2年分の株価データ不要
3. **リアルタイム性向上**: yfinance APIで最新データ
4. **IPO対応**: JPXスクレイピングで新規上場銘柄も自動取得
5. **シンプル化**: ポートフォリオ/ウォッチリスト統合でUI簡素化

---

## 追加検討事項（2025/02フィードバック）

### 1. LINE Bot化

**課題**: Webサービスとして存在する理由があるか？

**提案**: LINEログインを使ってLINE Botにする
- 毎日の情報をLINEで受け取れる
- プッシュ通知よりLINEの方が見られる
- 開発・運用もシンプルになる可能性

**LINE Messaging API 料金（2025年時点）:**

| プラン | 月額 | 無料メッセージ | 追加 |
|--------|------|---------------|------|
| コミュニケーション | 0円 | 200通 | 不可 |
| ライト | 5,500円 | 5,000通 | 不可 |
| スタンダード | 16,500円 | 30,000通 | 〜3円/通 |

**課金ルール:**
- Reply API（ユーザーへの返信）→ 無料
- Push API（こちらから送信）→ 課金対象

**コスト試算:**
- MVP検証（〜50人）: 1,500通/月 → ライトプラン（5,500円）
- 成長期（〜1,000人）: 30,000通/月 → スタンダードプラン（16,500円）

**結論**: MVP検証には十分現実的

### 2. 証券口座API連携

**アイデア**: 楽天証券などと自動連携して、保有銘柄を自動取得

- 手動でポートフォリオ入力する手間がなくなる
- リアルタイムで正確な情報が得られる
- 差別化要因になる

**調査結果（2025年2月時点）:**

| 証券会社 | API状況 | 個人利用 |
|----------|---------|----------|
| 楽天証券 | 個人向けAPIなし | × |
| SBI証券 | 先物オプションのみ、認定業者限定 | × |
| 立花証券e支店 | 無料REST API | △（第三者提供禁止） |
| auカブコム証券 | kabuステーション API | ○ |
| 岡三証券 | 岡三RSS（Excel経由） | ○ |

**立花証券の制限:**
> 「第三者に提供すること、営業に使用したり第三者へ提供する目的で加工および再利用することはできません」
→ サービスとしての利用は規約違反の可能性

**MVP方針:**
- 証券口座API連携は後回し
- まずは銘柄コード手入力でシンプルに
- 数量・購入価格は任意入力（入れたい人だけ）

**将来的な規約回避策:**
ユーザー自身のAPIキーを使う方式
```
1. ユーザーが立花証券e支店で口座開設
2. ユーザーが自分のAPIキーを発行
3. Stock BuddyにAPIキーを登録
4. Stock Buddyがユーザーのキーでデータ取得
```
→ サービスが「第三者提供」するのではなく、ユーザーが「自分のデータを取得」する形

**注意点:**
- 2025年7月〜 電話認証必須（自動化が面倒に）
- 立花証券口座持ちに限定される
- APIキーの安全な保存が必要

### 3. IPO銘柄データの取得

**課題**: yfinanceでは直近IPO銘柄が取得できない

**取得方法の比較:**

| 方法 | コスト | リアルタイム | 備考 |
|------|--------|-------------|------|
| JPXサイトスクレイピング | 無料 | ○ | 公式情報、正確 |
| J-Quants API（無料） | 0円 | × | 12週間遅延 |
| J-Quants API（有料） | 1,650円〜/月 | ○ | ライトプラン以上 |
| 立花証券API | 無料 | ○ | 口座開設必要 |

**推奨**: JPXサイトからスクレイピング
- [JPX 新規上場会社情報](https://www.jpx.co.jp/listing/stocks/new/index.html)
- 上場日、銘柄コード、会社名が取得可能

### 4. Twitter (X) データ取得

**アイデア**: 投資インフルエンサーや市場の話題をリアルタイムで収集

**背景**:
- 投資判断には「今、何が話題になっているか」が重要
- 著名投資家のツイートは市場に影響を与える
- リアルタイムな情報が差別化要因になる

**実装方針**:

| フェーズ | 方法 | コスト | 備考 |
|---------|------|--------|------|
| **MVP（短期）** | twikit（スクレイピング） | 無料 | 検証用、規約リスクあり |
| **本番（長期）** | Twitter API Basic | $100/月 | 10,000ツイート/月取得可能 |

**Twitter API料金（2025年時点）**:

| プラン | 月額 | 取得可能数 | 備考 |
|--------|------|-----------|------|
| Free | 0円 | 10,000ツイート/月（読み取りのみ） | 1アカウントのみ |
| Basic | $100/月 | 10,000ツイート/月 | OAuth 2.0対応 |
| Pro | $5,000/月 | 1,000,000ツイート/月 | エンタープライズ向け |

**収集対象例**:
- 投資インフルエンサー（じっちゃま @hirosetakao など）
- 特定銘柄の言及数・センチメント
- 市場トレンドワード（日経平均、半導体、など）

**情報収集戦略: 自動フォローで情報ソースを拡大**

投資関連の情報を網羅的に収集するため、twikitの自動フォロー機能を活用：

```python
# 1. 投資インフルエンサーリストを自動フォロー
influencers = [
    "hirosetakao",     # じっちゃま（米国株）
    "kabukyodai",      # 株教材（日本株）
    "fisco_jp",        # フィスコ（金融情報）
    "traders_web",     # トレーダーズ・ウェブ
    # ... 50-100人程度
]

for username in influencers:
    user = await client.get_user_by_screen_name(username)
    await client.follow_user(user.id)

# 2. フォロワー数・エンゲージメントで優良アカウントを発見
tweets = await client.search_tweet("日経平均 OR 日本株", "Latest", count=100)
for tweet in tweets:
    # 高エンゲージメント（RT 100以上、いいね 500以上）
    if tweet.retweet_count > 100 and tweet.favorite_count > 500:
        await client.follow_user(tweet.user.id)

# 3. フォロー中のユーザーのツイートを毎日収集
following = await client.get_user_following(my_user_id, count=100)
for user in following:
    tweets = await user.get_tweets("Tweets", count=10)
    # 投資関連ツイートをDBに保存
```

**自動フォローのメリット**:
- タイムラインに投資情報が自動的に流れる
- 新しい情報源を継続的に発見できる
- フォロー中ユーザーのツイート取得が効率的
- 情報の鮮度・質が向上

**フォロー数の制限**:
- Twitter（X）のフォロー上限: 1日400人まで
- 新規アカウントの場合: より低い制限あり
- 段階的にフォロー数を増やす（1日50人程度推奨）

**MVP実装**:
```python
# twikitを使用したスクレイピング
# - ログイン認証（Cookie保存）
# - キーワード検索（銘柄名、銘柄コード）
# - 投資関連アカウントの自動フォロー（段階的）
# - フォロー中ユーザーのタイムライン取得
# - エンゲージメント数（いいね、RT、表示回数）
```

**将来的な活用**:
- AIによるツイート要約・センチメント分析
- 「今日の話題銘柄」として表示
- 投資判断の補助材料として提供
- フォロワー数・エンゲージメントでアカウントをスコアリング
- 優良アカウントを自動的にフォロー継続

**注意点**:
- twikitはスクレイピングのため規約違反のリスク
- **過度なフォローはアカウント凍結の可能性**（1日50人程度に抑える）
- 商用利用する場合は早めにAPI移行を検討
- API移行時のコスト: $100/月（Basic）

### 5. コモディティ・為替情報

株だけでなく、金・為替などの情報も提供
- 金の暴落など、市場全体の動向を把握
- 分散投資の判断材料に

### 6. コピートレード機能

**アイデア**: バフェットなど著名投資家のポートフォリオをコピーできる

**競合**: [Bloomo（ブルーモ証券）](https://bloomo.co.jp/)
- 特許取得済み（特許第7523175号、2024年7月18日）
- ポートフォリオ投資機能
- ポートフォリオ共有機能（コピー機能）

**特許の内容**:
- ユーザーが銘柄と比率を指定→システムが売買計算・発注を代行
- 公式ポートフォリオをワンタップでコピーして自動投資

**対応方針**:
- 特許を避けたUI/UX設計が必要
- 「自動発注」ではなく「参考情報として表示」なら抵触しない可能性
- 法的確認が必要

### 7. ポートフォリオ公開＆バイラル

**アイデア**: ユーザーが自分のポートフォリオを公開し、他のユーザーがコピーできる

- コピーされた人に報酬（収益シェア）
- バイラル効果で拡散
- インフルエンサー投資家が集まる仕組み

### 8. マネタイズ

**価格帯**: 月額5,000円〜10,000円

**価値提案**:
- 証券口座連携で自動ポートフォリオ管理
- 著名投資家のポートフォリオをコピー
- 毎日の市場分析・銘柄情報

---

## 競合分析

### Bloomo（ブルーモ証券）

- 2024年5月一般公開の新興証券会社
- 米国株特化
- ポートフォリオ投資機能で特許取得
- バフェット、ビル・ゲイツのポートフォリオをコピー可能
- 日経新聞、Forbes、WBS等で取り上げ

**差別化ポイント候補**:
- 日本株対応
- LINE Bot化による手軽さ
- 楽天証券など既存口座との連携

---

## 次のステップ

### 方針転換: LINE Bot化を先にする

**理由:**
- 今のWebアプリを改修するより、LINE Botを新規で作る方がシンプル
- 既存のNext.js APIはそのまま活用できる
- 「毎日LINEで情報が届く」体験をすぐ検証できる
- Webアプリは管理画面として残すか、後で必要になったら作る

**構成イメージ:**
```
[LINE Bot] ← ユーザー
    ↓
[既存のNext.js API]
    ↓
[DB・分析ロジック]
```

---

### フェーズ1: LINE Bot MVP

1. [ ] LINE公式アカウント・Messaging API設定
2. [ ] Webhook受信エンドポイント作成
3. [ ] 銘柄登録機能（ユーザーがLINEで銘柄コード送信→登録）
4. [ ] 毎日の情報配信（Featured Stocks, Hot Stocks, 保有銘柄分析）
5. [ ] 投資スタイル設定（短期/中期/長期）

### フェーズ2: 機能拡充

6. [ ] 価格アラート通知
7. [ ] コモディティ・為替情報の追加
8. [ ] AIによる詳細分析

### フェーズ3: 拡張（検証後に判断）

9. [ ] Webアプリの改修 or 廃止
10. [ ] コピートレード機能の法的確認・設計
11. [ ] 証券口座API連携（需要があれば）
