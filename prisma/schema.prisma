// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NextAuth.js 認証
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String          @id @default(cuid())
  name          String?
  email         String?         @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
  portfolio     Portfolio?
  settings      UserSettings?
  watchlist     Watchlist[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ユーザー設定
model UserSettings {
  id                  String   @id @default(cuid())
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  investmentAmount    Int      // 初期投資金額
  monthlyAmount       Int      @default(0) // 月々の積立金額（0=積立なし/決まっていない）
  investmentPeriod    String   // 'short' | 'medium' | 'long'
  riskTolerance       String   // 'low' | 'medium' | 'high'
  isExistingInvestor  Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

// 銘柄マスタ
model Stock {
  id                String             @id @default(cuid())
  tickerCode        String             @unique
  name              String
  market            String
  sector            String?
  prices            StockPrice[]
  indicators        StockIndicator[]
  portfolioStocks   PortfolioStock[]
  transactions      Transaction[]
  dailyReports      DailyReport[]
  watchlists        Watchlist[]
  createdAt         DateTime           @default(now())

  @@index([tickerCode])
}

// 日次株価データ
model StockPrice {
  id            String   @id @default(cuid())
  stockId       String
  stock         Stock    @relation(fields: [stockId], references: [id], onDelete: Cascade)
  date          DateTime @db.Date
  open          Decimal  @db.Decimal(12, 2)
  high          Decimal  @db.Decimal(12, 2)
  low           Decimal  @db.Decimal(12, 2)
  close         Decimal  @db.Decimal(12, 2)
  volume        BigInt
  adjustedClose Decimal? @db.Decimal(12, 2)
  createdAt     DateTime @default(now())

  @@unique([stockId, date])
  @@index([stockId, date(sort: Desc)])
}

// 技術指標データ
model StockIndicator {
  id      String   @id @default(cuid())
  stockId String
  stock   Stock    @relation(fields: [stockId], references: [id], onDelete: Cascade)
  date    DateTime @db.Date
  sma25   Decimal? @db.Decimal(12, 2)
  sma75   Decimal? @db.Decimal(12, 2)
  rsi14   Decimal? @db.Decimal(5, 2)
  macd    Decimal? @db.Decimal(12, 4)
  signal  Decimal? @db.Decimal(12, 4)
  createdAt DateTime @default(now())

  @@unique([stockId, date])
  @@index([stockId, date(sort: Desc)])
}

// ポートフォリオ
model Portfolio {
  id             String           @id @default(cuid())
  userId         String           @unique
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  name           String           @default("マイポートフォリオ")
  isActive       Boolean          @default(true)
  stocks         PortfolioStock[]
  transactions   Transaction[]
  dailyReports   DailyReport[]
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
}

// 保有銘柄
model PortfolioStock {
  id           String    @id @default(cuid())
  portfolioId  String
  portfolio    Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  stockId      String
  stock        Stock     @relation(fields: [stockId], references: [id], onDelete: Cascade)
  quantity     Int
  averagePrice Decimal   @db.Decimal(12, 2)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([portfolioId, stockId])
  @@index([portfolioId])
}

// 売買履歴
model Transaction {
  id          String    @id @default(cuid())
  portfolioId String
  portfolio   Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  stockId     String
  stock       Stock     @relation(fields: [stockId], references: [id], onDelete: Cascade)
  type        String    // 'buy' | 'sell'
  quantity    Int
  price       Decimal   @db.Decimal(12, 2)
  totalAmount Decimal   @db.Decimal(12, 2)
  executedAt  DateTime
  note        String?
  createdAt   DateTime  @default(now())

  @@index([portfolioId, executedAt(sort: Desc)])
  @@index([stockId, executedAt(sort: Desc)])
}

// 毎日のBuddyレポート
model DailyReport {
  id                String    @id @default(cuid())
  portfolioId       String
  portfolio         Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  reportDate        DateTime  @db.Date
  action            String    // 'buy' | 'sell' | 'hold'
  targetStockId     String?
  targetStock       Stock?    @relation(fields: [targetStockId], references: [id])
  suggestedQuantity Int?
  suggestedPrice    Decimal?  @db.Decimal(12, 2)
  summary           String    @db.Text
  reasoning         String    @db.Text
  futurePlan        String?   @db.Text
  keyIndicators     Json?
  generatedAt       DateTime  @default(now())
  createdAt         DateTime  @default(now())

  @@unique([portfolioId, reportDate])
  @@index([portfolioId, reportDate(sort: Desc)])
  @@index([targetStockId, reportDate(sort: Desc)])
}

// ウォッチリスト（購入候補銘柄）
model Watchlist {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  stockId           String
  stock             Stock    @relation(fields: [stockId], references: [id], onDelete: Cascade)
  recommendedPrice  Decimal  @db.Decimal(12, 2)
  recommendedQty    Int
  reason            String?  @db.Text
  source            String   @default("onboarding") // 'onboarding' | 'manual' | 'report'
  createdAt         DateTime @default(now())

  @@unique([userId, stockId])
  @@index([userId])
}

// 指標解説マスタ
model IndicatorExplanation {
  id                   String   @id @default(cuid())
  indicatorName        String   @unique
  shortDescription     String
  detailedExplanation  String?  @db.Text
  exampleUsage         String?  @db.Text
  createdAt            DateTime @default(now())
}

// 市場ニュース
model MarketNews {
  id          String   @id @default(cuid())
  title       String
  content     String   @db.Text
  url         String?
  source      String   @default("tavily") // 'tavily' | 'yahoo' | 'nikkei' | 'reuters'
  sector      String?  // 関連セクター（複数の場合はカンマ区切り）
  sentiment   String?  // 'positive' | 'neutral' | 'negative'
  publishedAt DateTime
  createdAt   DateTime @default(now())

  @@index([publishedAt(sort: Desc)])
  @@index([sector])
  @@index([source])
}
