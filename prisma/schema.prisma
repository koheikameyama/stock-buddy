// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NextAuth.js 認証
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                      String                   @id @default(cuid())
  name                    String?
  email                   String?                  @unique
  emailVerified           DateTime?
  image                   String?
  termsAccepted           Boolean                  @default(false)
  termsAcceptedAt         DateTime?
  privacyPolicyAccepted   Boolean                  @default(false)
  privacyPolicyAcceptedAt DateTime?

  // 課金プラン（将来用）
  subscriptionPlan        String                   @default("free") // 'free' | 'premium'
  subscriptionExpiry      DateTime?

  accounts                Account[]
  sessions                Session[]
  portfolio               Portfolio?
  settings                UserSettings?
  watchlist               Watchlist[]
  coachMessages           CoachMessage[]
  portfolioStockAnalyses  PortfolioStockAnalysis[]
  recommendationLogs      RecommendationLog[]
  pushSubscriptions       PushSubscription[]
  stockRequests           StockRequest[]
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ユーザー設定
model UserSettings {
  id                  String   @id @default(cuid())
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  investmentAmount    Int?     // 初期投資金額（オプショナル・非推奨: AI推奨時のみ使用）
  monthlyAmount       Int?     // 月々の積立金額（オプショナル・将来的に削除予定）
  investmentPeriod    String   // 'short' | 'medium' | 'long'
  riskTolerance       String   // 'low' | 'medium' | 'high'
  isExistingInvestor  Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

// 銘柄マスタ
model Stock {
  id                String             @id @default(cuid())
  tickerCode        String             @unique
  name              String
  market            String
  sector            String?
  marketCap         Decimal?           // 時価総額（億円）
  dividendYield     Decimal?           // 配当利回り（%）

  // 財務指標
  pbr               Decimal?           @db.Decimal(8, 2)  // 株価純資産倍率 (Price to Book Ratio)
  per               Decimal?           @db.Decimal(8, 2)  // 株価収益率 (Price to Earnings Ratio)
  roe               Decimal?           @db.Decimal(8, 4)  // 自己資本利益率 (Return on Equity)
  operatingCF       Decimal?           @db.Decimal(15, 2) // 営業キャッシュフロー
  freeCF            Decimal?           @db.Decimal(15, 2) // フリーキャッシュフロー

  // その他の有用な指標
  currentPrice      Decimal?           @db.Decimal(12, 2) // 現在株価
  fiftyTwoWeekHigh  Decimal?           @db.Decimal(12, 2) // 52週高値
  fiftyTwoWeekLow   Decimal?           @db.Decimal(12, 2) // 52週安値

  // 財務データの最終更新日時
  financialDataUpdatedAt DateTime?

  // 各種スコア（0-100）
  beginnerScore     Int?               // 初心者おすすめ度（安定性・知名度・分かりやすさ）
  growthScore       Int?               // 成長性スコア（値上がり期待）
  dividendScore     Int?               // 高配当スコア（インカムゲイン重視）
  stabilityScore    Int?               // 安定性スコア（低リスク・低変動）
  liquidityScore    Int?               // 流動性スコア（売買のしやすさ）

  prices            StockPrice[]
  indicators        StockIndicator[]
  portfolioStocks   PortfolioStock[]
  transactions      Transaction[]
  dailyReports      DailyReport[]
  watchlists        Watchlist[]
  analyses          StockAnalysis[]
  featuredStocks    DailyFeaturedStock[]
  hotStocks         HotStock[]
  createdAt         DateTime           @default(now())

  @@index([tickerCode])
}

// 日次株価データ
model StockPrice {
  id            String   @id @default(cuid())
  stockId       String
  stock         Stock    @relation(fields: [stockId], references: [id], onDelete: Cascade)
  date          DateTime @db.Date
  open          Decimal  @db.Decimal(12, 2)
  high          Decimal  @db.Decimal(12, 2)
  low           Decimal  @db.Decimal(12, 2)
  close         Decimal  @db.Decimal(12, 2)
  volume        BigInt
  adjustedClose Decimal? @db.Decimal(12, 2)
  createdAt     DateTime @default(now())

  @@unique([stockId, date])
  @@index([stockId, date(sort: Desc)])
}

// 技術指標データ
model StockIndicator {
  id      String   @id @default(cuid())
  stockId String
  stock   Stock    @relation(fields: [stockId], references: [id], onDelete: Cascade)
  date    DateTime @db.Date
  sma25   Decimal? @db.Decimal(12, 2)
  sma75   Decimal? @db.Decimal(12, 2)
  rsi14   Decimal? @db.Decimal(5, 2)
  macd    Decimal? @db.Decimal(12, 4)
  signal  Decimal? @db.Decimal(12, 4)
  createdAt DateTime @default(now())

  @@unique([stockId, date])
  @@index([stockId, date(sort: Desc)])
}

// ポートフォリオ
model Portfolio {
  id             String              @id @default(cuid())
  userId         String              @unique
  user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  name           String              @default("マイポートフォリオ")
  isActive       Boolean             @default(true)
  stocks         PortfolioStock[]
  transactions   Transaction[]
  dailyReports   DailyReport[]
  snapshots      PortfolioSnapshot[]
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
}

// ポートフォリオの日次スナップショット（評価額記録）
model PortfolioSnapshot {
  id          String    @id @default(cuid())
  portfolioId String
  portfolio   Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  date        DateTime  @db.Date
  totalValue  Decimal   @db.Decimal(15, 2) // 総評価額
  totalCost   Decimal   @db.Decimal(15, 2) // 総取得価額
  gainLoss    Decimal   @db.Decimal(15, 2) // 損益額
  gainLossPct Decimal   @db.Decimal(5, 2)  // 損益率（%）
  createdAt   DateTime  @default(now())

  @@unique([portfolioId, date])
  @@index([portfolioId, date(sort: Desc)])
}

// 保有銘柄
model PortfolioStock {
  id              String                   @id @default(cuid())
  portfolioId     String
  portfolio       Portfolio                @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  stockId         String
  stock           Stock                    @relation(fields: [stockId], references: [id], onDelete: Cascade)
  quantity        Int
  averagePrice    Decimal                  @db.Decimal(12, 2)
  isSimulation    Boolean                  @default(true) // シミュレーション or 実投資
  analyses        PortfolioStockAnalysis[]

  // 価格アラート機能
  targetPrice     Decimal?  @db.Decimal(12, 2) // 目標価格
  targetCondition String?                      // 'above' | 'below'
  priceAlert      Boolean   @default(false)    // 価格アラート有効/無効（既存データ考慮でデフォルトfalse）
  lastAlertSent   DateTime?                    // 最後にアラートを送信した日時

  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt

  @@unique([portfolioId, stockId])
  @@index([portfolioId])
  @@index([portfolioId, priceAlert])
}

// 売買履歴
model Transaction {
  id          String    @id @default(cuid())
  portfolioId String
  portfolio   Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  stockId     String
  stock       Stock     @relation(fields: [stockId], references: [id], onDelete: Cascade)
  type        String    // 'buy' | 'sell'
  quantity    Int
  price       Decimal   @db.Decimal(12, 2)
  totalAmount Decimal   @db.Decimal(12, 2)
  executedAt  DateTime
  note        String?
  createdAt   DateTime  @default(now())

  @@index([portfolioId, executedAt(sort: Desc)])
  @@index([stockId, executedAt(sort: Desc)])
}

// 毎日のBuddyレポート
model DailyReport {
  id                String    @id @default(cuid())
  portfolioId       String
  portfolio         Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  reportDate        DateTime  @db.Date
  action            String    // 'buy' | 'sell' | 'hold'
  targetStockId     String?
  targetStock       Stock?    @relation(fields: [targetStockId], references: [id])
  suggestedQuantity Int?
  suggestedPrice    Decimal?  @db.Decimal(12, 2)
  summary           String    @db.Text
  reasoning         String    @db.Text
  futurePlan        String?   @db.Text
  keyIndicators     Json?
  generatedAt       DateTime  @default(now())
  createdAt         DateTime  @default(now())

  @@unique([portfolioId, reportDate])
  @@index([portfolioId, reportDate(sort: Desc)])
  @@index([targetStockId, reportDate(sort: Desc)])
}

// ウォッチリスト（気になる銘柄の監視リスト）
model Watchlist {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  stockId         String
  stock           Stock     @relation(fields: [stockId], references: [id], onDelete: Cascade)

  // 価格アラート機能
  targetPrice     Decimal?  @db.Decimal(12, 2) // 目標価格
  targetCondition String?                      // 'above' | 'below'
  priceAlert      Boolean   @default(true)     // 価格アラート有効/無効
  lastAlertSent   DateTime?                    // 最後にアラートを送信した日時

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([userId, stockId])
  @@index([userId])
  @@index([userId, priceAlert])
}

// 指標解説マスタ
model IndicatorExplanation {
  id                   String   @id @default(cuid())
  indicatorName        String   @unique
  shortDescription     String
  detailedExplanation  String?  @db.Text
  exampleUsage         String?  @db.Text
  createdAt            DateTime @default(now())
}

// 市場ニュース
model MarketNews {
  id          String   @id @default(cuid())
  title       String
  content     String   @db.Text
  url         String?
  source      String   @default("tavily") // 'tavily' | 'yahoo' | 'nikkei' | 'reuters'
  sector      String?  // 関連セクター（複数の場合はカンマ区切り）
  sentiment   String?  // 'positive' | 'neutral' | 'negative'
  publishedAt DateTime
  createdAt   DateTime @default(now())

  @@index([publishedAt(sort: Desc)])
  @@index([sector])
  @@index([source])
}

// コーチからの毎日のメッセージ
model CoachMessage {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date      DateTime @db.Date
  message   String   @db.Text
  type      String   // 'encouragement' | 'advice' | 'milestone' | 'market_update'
  createdAt DateTime @default(now())

  @@unique([userId, date])
  @@index([userId, date(sort: Desc)])
}

// 銘柄分析（AI予測機能）
model StockAnalysis {
  id                  String   @id @default(cuid())
  stockId             String
  stock               Stock    @relation(fields: [stockId], references: [id], onDelete: Cascade)

  // 短期予測（1週間）
  shortTermTrend      String   // 'up' | 'neutral' | 'down'
  shortTermPriceLow   Decimal  @db.Decimal(12, 2)
  shortTermPriceHigh  Decimal  @db.Decimal(12, 2)

  // 中期予測（1ヶ月）
  midTermTrend        String   // 'up' | 'neutral' | 'down'
  midTermPriceLow     Decimal  @db.Decimal(12, 2)
  midTermPriceHigh    Decimal  @db.Decimal(12, 2)

  // 長期予測（3ヶ月）
  longTermTrend       String   // 'up' | 'neutral' | 'down'
  longTermPriceLow    Decimal  @db.Decimal(12, 2)
  longTermPriceHigh   Decimal  @db.Decimal(12, 2)

  // 総合推奨
  recommendation      String   // 'buy' | 'hold' | 'sell'
  advice              String   @db.Text // AI生成のアドバイス
  confidence          Float    // 0.0 - 1.0

  analyzedAt          DateTime @default(now())
  createdAt           DateTime @default(now())

  @@unique([stockId, analyzedAt])
  @@index([stockId, analyzedAt(sort: Desc)])
  @@index([analyzedAt(sort: Desc)])
}

// 保有銘柄分析（ポートフォリオ用 - ユーザー固有の分析）
model PortfolioStockAnalysis {
  id                String         @id @default(cuid())
  userId            String
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  portfolioStockId  String
  portfolioStock    PortfolioStock @relation(fields: [portfolioStockId], references: [id], onDelete: Cascade)
  date              DateTime       @db.Date
  currentPrice      Decimal        @db.Decimal(12, 2)
  currentValue      Decimal        @db.Decimal(15, 2)  // 現在評価額
  gainLoss          Decimal        @db.Decimal(15, 2)  // 損益額
  gainLossPct       Decimal        @db.Decimal(5, 2)   // 損益率（%）
  action            String         // 'hold' | 'buy_more' | 'sell_partial' | 'sell_all'
  analysis          String         @db.Text             // AI生成の分析テキスト
  reasoning         String?        @db.Text             // アクション推奨の理由
  createdAt         DateTime       @default(now())

  @@unique([portfolioStockId, date])
  @@index([userId, date(sort: Desc)])
  @@index([portfolioStockId, date(sort: Desc)])
  @@index([date(sort: Desc)])
}

// オンボーディング推奨ログ（分析用）
model RecommendationLog {
  id                String   @id @default(cuid())
  userId            String?
  user              User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  budget            Int
  period            String   // 'short' | 'medium' | 'long'
  riskTolerance     String   // 'low' | 'medium' | 'high'
  targetStockCount  Int      // 目標銘柄数
  candidateStocks   Int      // 候補銘柄数（スコアリング後）
  affordableStocks  Int      // 購入可能銘柄数
  selectedStocks    Int      // 実際に選択された銘柄数
  totalAmount       Decimal  @db.Decimal(15, 2) // 合計購入金額
  budgetUsageRate   Decimal  @db.Decimal(5, 2)  // 予算使用率（%）
  stocks            Json     // 選択された銘柄の詳細 [{name, ticker, price, quantity, total, score}]
  prompt            String?  @db.Text           // AIに送信したプロンプト（分析・改善用）
  createdAt         DateTime @default(now())

  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@index([budget])
  @@index([period])
}

// プッシュ通知購読
model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// 今日の注目銘柄（全ユーザー共通）
model DailyFeaturedStock {
  id          String   @id @default(cuid())
  date        DateTime @db.Date
  stockId     String
  stock       Stock    @relation(fields: [stockId], references: [id], onDelete: Cascade)
  position    Int      // 表示順序（1, 2, 3）
  reason      String   @db.Text // 注目理由
  score       Int      // 選定時のスコア
  createdAt   DateTime @default(now())

  @@unique([date, position])
  @@index([date(sort: Desc)])
  @@index([stockId])
}

// 今週のチャンス銘柄（ハイリスク・ハイリターン銘柄）
model HotStock {
  id              String    @id @default(cuid())
  stockId         String
  stock           Stock     @relation(fields: [stockId], references: [id], onDelete: Cascade)

  // ホットスコア（0-100）
  hotScore        Int

  // チャンスの理由
  reasons         String[]  // ["先週から+15%", "半導体需要急増", ...]

  // リスク要因
  risks           String[]  // ["短期的に大きく変動", "ボラティリティ高", ...]

  // 推奨投資額（予算の%）
  recommendedBudgetPercent Int  // 10-20

  // AIからの推奨コメント
  recommendation  String    @db.Text

  // 信頼度（0.0-1.0）
  confidence      Float

  // 有効期限（通常は1週間）
  validUntil      DateTime

  // メタ情報
  analyzedAt      DateTime  @default(now())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([stockId, analyzedAt])
  @@index([stockId])
  @@index([hotScore])
  @@index([validUntil])
  @@index([analyzedAt(sort: Desc)])
}

// 銘柄追加リクエスト
model StockRequest {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // リクエストされた銘柄情報
  tickerCode  String   // "6600.T"（東証）、"AAPL"（米国）など
  name        String?  // "キオクシアホールディングス"
  market      String?  // "東証プライム"など
  reason      String?  // ユーザーが追加したい理由（任意）

  // ステータス管理
  status      String   @default("pending") // pending, approved, rejected, added
  adminNote   String?  // 管理者メモ（却下理由など）

  // メタ情報
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([tickerCode])
  @@index([createdAt(sort: Desc)])
}
