// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NextAuth.js 認証
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                      String                   @id @default(cuid())
  name                    String?
  email                   String?                  @unique
  emailVerified           DateTime?
  image                   String?
  termsAccepted           Boolean                  @default(false)
  termsAcceptedAt         DateTime?
  privacyPolicyAccepted   Boolean                  @default(false)
  privacyPolicyAcceptedAt DateTime?

  // ロール
  role                    String                   @default("user") // 'user' | 'admin'

  // 課金プラン（将来用）
  subscriptionPlan        String                   @default("free") // 'free' | 'premium'
  subscriptionExpiry      DateTime?

  accounts                  Account[]
  sessions                  Session[]
  settings                  UserSettings?
  pushSubscriptions         PushSubscription[]
  stockRequests             StockRequest[]
  watchlistStocks           WatchlistStock[]
  portfolioStocks           PortfolioStock[]
  transactions              Transaction[]
  dailyRecommendations      UserDailyRecommendation[]
  trackedStocks             TrackedStock[]
  portfolioOverallAnalysis  PortfolioOverallAnalysis?

  // 通知
  notifications             Notification[]

  // 資産スナップショット
  portfolioSnapshots        PortfolioSnapshot[]

  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ユーザー設定
model UserSettings {
  id                  String   @id @default(cuid())
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  investmentPeriod    String   // 'short' | 'medium' | 'long'
  riskTolerance       String   // 'low' | 'medium' | 'high'
  investmentBudget    Int?     // 投資資金（円）例: 100000, 300000, 500000, 1000000
  targetReturnRate    Int?     // 目標利益率（%）: 5, 10, 15, 20, 30
  stopLossRate        Int?     // 損切りライン（%）: -5, -10, -15, -20
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

// 銘柄マスタ
model Stock {
  id                String             @id @default(cuid())
  tickerCode        String             @unique
  name              String
  market            String
  sector            String?
  marketCap         Decimal?           // 時価総額（億円）
  dividendYield     Decimal?           // 配当利回り（%）

  // 財務指標
  pbr               Decimal?           @db.Decimal(8, 2)  // 株価純資産倍率 (Price to Book Ratio)
  per               Decimal?           @db.Decimal(8, 2)  // 株価収益率 (Price to Earnings Ratio)
  roe               Decimal?           @db.Decimal(8, 4)  // 自己資本利益率 (Return on Equity)
  operatingCF       Decimal?           @db.Decimal(15, 2) // 営業キャッシュフロー
  freeCF            Decimal?           @db.Decimal(15, 2) // フリーキャッシュフロー

  // その他の有用な指標
  fiftyTwoWeekHigh  Decimal?           @db.Decimal(12, 2) // 52週高値
  fiftyTwoWeekLow   Decimal?           @db.Decimal(12, 2) // 52週安値

  // 最新株価データ（バッチ更新用）
  latestPrice       Decimal?           @db.Decimal(12, 2) // 最新株価
  latestVolume      BigInt?            // 最新出来高
  dailyChangeRate   Decimal?           @db.Decimal(8, 2)  // 前日比変化率（%）
  weekChangeRate    Decimal?           @db.Decimal(8, 2)  // 週間変化率（%）
  volatility        Decimal?           @db.Decimal(8, 2)  // 30日間ボラティリティ（%）
  volumeRatio       Decimal?           @db.Decimal(8, 2)  // 出来高比率（直近3日/4-30日前）
  maDeviationRate   Decimal?           @db.Decimal(8, 2)  // 25日移動平均乖離率（%）
  priceUpdatedAt    DateTime?          // 株価更新日時

  // 財務データの最終更新日時
  financialDataUpdatedAt DateTime?

  // 業績データ（yfinanceから取得）
  latestRevenue          Decimal?           @db.Decimal(18, 0) // 直近通期売上高（円）
  latestNetIncome        Decimal?           @db.Decimal(18, 0) // 直近通期純利益（円）
  revenueGrowth          Decimal?           @db.Decimal(8, 2)  // 売上高前年比（%）
  netIncomeGrowth        Decimal?           @db.Decimal(8, 2)  // 純利益前年比（%）
  eps                    Decimal?           @db.Decimal(12, 2) // 1株当たり利益（EPS）
  isProfitable           Boolean?           // 黒字かどうか
  profitTrend            String?            // 'increasing' | 'decreasing' | 'stable'
  earningsUpdatedAt      DateTime?          // 業績データ更新日時

  // 事業内容（yfinance + OpenAI翻訳で取得）
  businessDescription    String?            @db.Text // 企業の事業概要（日本語）
  businessDescriptionUpdatedAt DateTime?    // 事業内容の更新日時

  // IPO対応
  listedDate        DateTime?          // 上場日

  // 株価取得失敗トラッキング
  fetchFailCount    Int       @default(0)  // 連続失敗回数
  lastFetchFailedAt DateTime?              // 最後に失敗した日時
  isDelisted        Boolean   @default(false) // 上場廃止フラグ

  analyses                StockAnalysis[]
  featuredStocks          DailyFeaturedStock[]
  watchlistStocks         WatchlistStock[]
  portfolioStocks         PortfolioStock[]
  transactions            Transaction[]
  purchaseRecommendations PurchaseRecommendation[]
  userDailyRecommendations UserDailyRecommendation[]
  trackedStocks           TrackedStock[]
  dailyMarketMovers       DailyMarketMover[]
  notifications           Notification[]
  recommendationOutcomes  RecommendationOutcome[]
  createdAt               DateTime @default(now())

  @@index([tickerCode])
}

// マーケットニュース
model MarketNews {
  id          String   @id @default(cuid())
  title       String
  content     String   @db.Text
  url         String?
  source      String   @default("tavily")
  sector      String?
  sentiment   String?  // 'positive' | 'negative' | 'neutral'
  publishedAt DateTime
  createdAt   DateTime @default(now())
  market      String   @default("JP") // "JP" or "US"
  region      String?  // "日本", "米国" など（表示用）

  @@index([publishedAt(sort: Desc)])
  @@index([sector])
  @@index([source])
  @@index([market])
}

// セクタートレンド分析（ニュース + 株価統合）
model SectorTrend {
  id        String   @id @default(cuid())
  date      DateTime @db.Date
  sector    String

  // 3日窓（短期の勢い）- ニュース
  score3d       Float
  newsCount3d   Int
  positive3d    Int
  negative3d    Int
  neutral3d     Int

  // 7日窓（中期トレンド）- ニュース
  score7d       Float
  newsCount7d   Int
  positive7d    Int
  negative7d    Int
  neutral7d     Int

  // US→JP連動
  usNewsCount3d Int   @default(0)
  usNewsCount7d Int   @default(0)

  // 株価モメンタム（セクター内全銘柄の平均）
  avgWeekChangeRate   Float?   // セクター平均週間変化率（%）
  avgDailyChangeRate  Float?   // セクター平均日次変化率（%）
  avgMaDeviationRate  Float?   // セクター平均MA乖離率（%）
  avgVolumeRatio      Float?   // セクター平均出来高比率
  avgVolatility       Float?   // セクター平均ボラティリティ（%）
  stockCount          Int      @default(0) // 集計対象の銘柄数

  // 総合スコア（ニュース + 株価を統合）
  compositeScore      Float?   // -100 〜 +100

  // メタ
  trendDirection String   // "up" | "down" | "neutral"
  createdAt  DateTime @default(now())

  @@unique([date, sector])
  @@index([date])
  @@index([sector])
}

// 銘柄分析（AI予測機能）
model StockAnalysis {
  id                  String   @id @default(cuid())
  stockId             String
  stock               Stock    @relation(fields: [stockId], references: [id], onDelete: Cascade)

  // 短期予測（1週間）
  shortTermTrend      String   // 'up' | 'neutral' | 'down'
  shortTermPriceLow   Decimal  @db.Decimal(12, 2)
  shortTermPriceHigh  Decimal  @db.Decimal(12, 2)

  // 中期予測（1ヶ月）
  midTermTrend        String   // 'up' | 'neutral' | 'down'
  midTermPriceLow     Decimal  @db.Decimal(12, 2)
  midTermPriceHigh    Decimal  @db.Decimal(12, 2)

  // 長期予測（3ヶ月）
  longTermTrend       String   // 'up' | 'neutral' | 'down'
  longTermPriceLow    Decimal  @db.Decimal(12, 2)
  longTermPriceHigh   Decimal  @db.Decimal(12, 2)

  // 総合推奨
  recommendation      String   // 'buy' | 'hold' | 'sell'
  advice              String   @db.Text // AI生成のアドバイス
  confidence          Float    // 0.0 - 1.0

  // 指値・逆指値
  limitPrice          Decimal? @db.Decimal(12, 2) // 指値（理想の買値）
  stopLossPrice       Decimal? @db.Decimal(12, 2) // 逆指値（損切りライン）

  // テキスト分析（ポートフォリオ・ウォッチリスト共通）
  shortTermText       String?  @db.Text           // 短期予測テキスト
  midTermText         String?  @db.Text           // 中期予測テキスト
  longTermText        String?  @db.Text           // 長期予測テキスト

  // ステータス情報
  statusType          String?                     // "good", "neutral", "caution", "warning"

  // 売却条件
  sellCondition       String?  @db.Text           // 売却判断の条件テキスト

  analyzedAt          DateTime @default(now())
  createdAt           DateTime @default(now())

  @@unique([stockId, analyzedAt])
  @@index([stockId, analyzedAt(sort: Desc)])
  @@index([analyzedAt(sort: Desc)])
}


// プッシュ通知購読
model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// 今日の注目銘柄（全ユーザー共通）
model DailyFeaturedStock {
  id          String   @id @default(cuid())
  date        DateTime @db.Date
  stockId     String
  stock       Stock    @relation(fields: [stockId], references: [id], onDelete: Cascade)
  category    String   @default("stable") // surge: 短期急騰, stable: 中長期安定, trending: 話題
  position    Int      // 表示順序（1, 2, 3）
  reason      String   @db.Text // 注目理由
  score       Int      // 選定時のスコア
  createdAt   DateTime @default(now())

  @@unique([date, position])
  @@index([date(sort: Desc)])
  @@index([stockId])
  @@index([date, category])
}


// 銘柄追加リクエスト
model StockRequest {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // リクエストされた銘柄情報
  tickerCode  String   // "6600.T"（東証）、"AAPL"（米国）など
  name        String?  // "キオクシアホールディングス"
  market      String?  // "東証プライム"など
  reason      String?  // ユーザーが追加したい理由（任意）

  // ステータス管理
  status      String   @default("pending") // pending, approved, rejected, added
  adminNote   String?  // 管理者メモ（却下理由など）

  // メタ情報
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([tickerCode])
  @@index([createdAt(sort: Desc)])
}

// ウォッチリスト（気になる銘柄）
model WatchlistStock {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  stockId     String
  stock       Stock    @relation(fields: [stockId], references: [id], onDelete: Cascade)

  // 買い時通知の目標価格（この価格以下で通知）
  targetBuyPrice Decimal? @db.Decimal(12, 2)

  // おすすめ経由で追加された場合の情報
  investmentTheme      String?
  recommendationReason String?  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, stockId])
  @@index([userId])
  @@index([stockId])
}

// ポートフォリオ（保有銘柄）
// quantity と averagePurchasePrice は Transaction から計算
model PortfolioStock {
  id      String @id @default(cuid())
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  stockId String
  stock   Stock  @relation(fields: [stockId], references: [id], onDelete: Cascade)

  // AI分析結果（売買判断用）
  lastAnalysis DateTime?
  shortTerm    String?   @db.Text
  mediumTerm   String?   @db.Text
  longTerm     String?   @db.Text

  // ステータス
  statusType         String?            // good/caution/excellent/neutral/warning

  // 市場シグナル（評価軸の統一）
  marketSignal         String?                     // "bullish" | "neutral" | "bearish"

  // 売却提案
  suggestedSellPrice   Decimal? @db.Decimal(12, 2) // 提案売却価格
  suggestedSellPercent Int?                        // 推奨売却割合（25, 50, 75, 100）
  sellCondition        String?  @db.Text           // 売却条件
  sellReason           String?  @db.Text           // 売却理由（AIが生成）
  sellTiming           String?                     // "market" | "rebound" | null
  sellTargetPrice      Decimal? @db.Decimal(12, 2) // 戻り売り時の目安価格（SMA25）

  // 取引履歴
  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, stockId])
  @@index([userId])
  @@index([stockId])
}

// 取引履歴
model Transaction {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  stockId          String
  stock            Stock    @relation(fields: [stockId], references: [id], onDelete: Cascade)
  portfolioStockId String?
  portfolioStock   PortfolioStock? @relation(fields: [portfolioStockId], references: [id], onDelete: SetNull)

  // 取引情報
  type            String   // "buy" | "sell"
  quantity        Int
  price           Decimal  @db.Decimal(12, 2)
  totalAmount     Decimal  @db.Decimal(15, 2)
  transactionDate DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([stockId])
  @@index([portfolioStockId])
  @@index([transactionDate(sort: Desc)])
  @@index([type])
}

// 購入判断分析（ウォッチリスト向け）
model PurchaseRecommendation {
  id     String   @id @default(cuid())
  stockId String
  stock   Stock   @relation(fields: [stockId], references: [id], onDelete: Cascade)
  date    DateTime @db.Date

  // 基本判断
  recommendation String // "buy" | "stay"
  confidence     Float  // 0.0-1.0

  // 説明
  reason  String @db.Text
  caution String @db.Text

  // B. 深掘り評価
  positives            String?  @db.Text    // 良いところ（箇条書き）
  concerns             String?  @db.Text    // 不安な点（箇条書き）
  suitableFor          String?  @db.Text    // こんな人向け

  // C. 買い時条件（stayの時に表示）
  buyCondition         String?  @db.Text    // どうなったら買い時か
  buyTiming            String?              // "market" | "dip" | null（買い推奨時の購入タイミング）
  dipTargetPrice       Decimal? @db.Decimal(12, 2)  // 押し目買い時の目安価格（SMA25）
  sellTiming           String?                      // "market" | "rebound" | null（avoid時のみ）
  sellTargetPrice      Decimal? @db.Decimal(10, 2)  // 戻り売り時の目安価格（SMA25）

  // D. パーソナライズ（ユーザー設定に基づく評価）
  userFitScore         Int?                 // おすすめ度 0-100
  budgetFit            Boolean?             // 予算内で購入可能？
  periodFit            Boolean?             // 投資期間にマッチ？
  riskFit              Boolean?             // リスク許容度に合う？
  personalizedReason   String?  @db.Text    // パーソナライズされた理由

  // 市場シグナル（評価軸の統一）
  marketSignal         String?  // "bullish" | "neutral" | "bearish"

  // 将来拡張用
  analysisData Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([stockId, date])
  @@index([date])
  @@index([stockId])
}

// 追跡銘柄（AI分析なしで株価だけ追いたい銘柄）
model TrackedStock {
  id      String @id @default(cuid())
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  stockId String
  stock   Stock  @relation(fields: [stockId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, stockId])
  @@index([userId])
  @@index([stockId])
}

// ユーザーごとのAIおすすめ銘柄（毎日バッチで生成）
model UserDailyRecommendation {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date        DateTime @db.Date
  stockId     String
  stock       Stock    @relation(fields: [stockId], references: [id], onDelete: Cascade)
  position    Int      // 表示順序（1, 2, 3）
  reason      String   @db.Text // AIが生成した初心者向け理由
  investmentTheme String? // 投資テーマ: "短期成長" | "中長期安定成長" | "高配当" | "割安反発" | "テクニカル好転" | "安定ディフェンシブ"
  createdAt   DateTime @default(now())

  @@unique([userId, date, position])
  @@index([userId, date(sort: Desc)])
  @@index([stockId])
}

// 非同期分析ジョブ
model AnalysisJob {
  id          String   @id @default(cuid())
  userId      String
  type        String   // "portfolio-analysis" | "purchase-recommendation" | "overall-analysis"
  targetId    String?  // stockId等（typeによって異なる）
  status      String   @default("pending") // "pending" | "processing" | "completed" | "failed"
  result      Json?    // 分析結果（完了時）
  error       String?  // エラーメッセージ（失敗時）
  createdAt   DateTime @default(now())
  startedAt   DateTime?
  completedAt DateTime?

  @@index([userId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
}

// ポートフォリオ総評分析（ユーザーごと）
model PortfolioOverallAnalysis {
  id                     String   @id @default(cuid())
  userId                 String   @unique
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  analyzedAt             DateTime

  // 数値指標
  sectorConcentration    Decimal? @db.Decimal(5, 2)  // 最大セクター比率(%)
  sectorCount            Int?                         // セクター数
  totalValue             Decimal? @db.Decimal(15, 2)  // 総資産額
  totalCost              Decimal? @db.Decimal(15, 2)  // 総投資額
  unrealizedGain         Decimal? @db.Decimal(15, 2)  // 含み損益
  unrealizedGainPercent  Decimal? @db.Decimal(8, 2)   // 含み損益率(%)
  portfolioVolatility    Decimal? @db.Decimal(8, 2)   // ポートフォリオ全体のボラティリティ(%)

  // AI生成テキスト
  overallSummary         String   @db.Text            // 全体の総評（2-3文）
  overallStatus          String                       // 好調/順調/やや低調/注意/要確認
  overallStatusType      String                       // excellent/good/neutral/caution/warning
  metricsAnalysis        Json                         // 各指標の解説・評価・アクション提案
  actionSuggestions      Json                         // 推奨アクションリスト
  watchlistSimulation    Json?                        // ウォッチリスト銘柄追加時の予測

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([userId])
  @@index([analyzedAt(sort: Desc)])
}

// 週次AI精度レポート
model WeeklyAIReport {
  id        String   @id @default(cuid())
  weekStart DateTime @db.Date  // レポート対象週の開始日
  weekEnd   DateTime @db.Date  // レポート対象週の終了日

  // おすすめ銘柄
  dailyRecommendationCount       Int?
  dailyRecommendationAvgReturn   Decimal? @db.Decimal(8, 2)
  dailyRecommendationPlusRate    Decimal? @db.Decimal(5, 2)
  dailyRecommendationSuccessRate Decimal? @db.Decimal(5, 2)
  dailyRecommendationImprovement String?

  // 購入判断
  purchaseRecommendationCount       Int?
  purchaseRecommendationAvgReturn   Decimal? @db.Decimal(8, 2)
  purchaseRecommendationPlusRate    Decimal? @db.Decimal(5, 2)
  purchaseRecommendationSuccessRate Decimal? @db.Decimal(5, 2)
  purchaseRecommendationImprovement String?

  // 銘柄分析
  stockAnalysisCount       Int?
  stockAnalysisAvgReturn   Decimal? @db.Decimal(8, 2)
  stockAnalysisPlusRate    Decimal? @db.Decimal(5, 2)
  stockAnalysisSuccessRate Decimal? @db.Decimal(5, 2)
  stockAnalysisImprovement String?

  // 詳細データ（JSON）
  details Json?  // ベスト/ワースト、セクター別等

  createdAt DateTime @default(now())

  @@unique([weekStart])
  @@index([weekStart])
}

// 日次AI精度レポート（毎日生成、過去7日間の滚动集計）
model DailyAIReport {
  id   String   @id @default(cuid())
  date DateTime @db.Date  // レポート生成日（JST）

  // おすすめ銘柄
  dailyRecommendationCount       Int?
  dailyRecommendationAvgReturn   Decimal? @db.Decimal(8, 2)
  dailyRecommendationPlusRate    Decimal? @db.Decimal(5, 2)
  dailyRecommendationSuccessRate Decimal? @db.Decimal(5, 2)
  dailyRecommendationImprovement String?

  // 購入判断
  purchaseRecommendationCount       Int?
  purchaseRecommendationAvgReturn   Decimal? @db.Decimal(8, 2)
  purchaseRecommendationPlusRate    Decimal? @db.Decimal(5, 2)
  purchaseRecommendationSuccessRate Decimal? @db.Decimal(5, 2)
  purchaseRecommendationImprovement String?

  // 銘柄分析
  stockAnalysisCount       Int?
  stockAnalysisAvgReturn   Decimal? @db.Decimal(8, 2)
  stockAnalysisPlusRate    Decimal? @db.Decimal(5, 2)
  stockAnalysisSuccessRate Decimal? @db.Decimal(5, 2)
  stockAnalysisImprovement String?

  // 詳細データ（JSON）
  details Json?  // ベスト/ワースト、セクター別等

  createdAt DateTime @default(now())

  @@unique([date])
  @@index([date(sort: Desc)])
}

// 日次上昇/下落ランキング（場後に生成）
model DailyMarketMover {
  id          String   @id @default(cuid())
  date        DateTime @db.Date
  stockId     String
  stock       Stock    @relation(fields: [stockId], references: [id], onDelete: Cascade)
  type        String   // 'gainer' | 'loser'
  position    Int      // 表示順序（1-5）
  changeRate  Decimal  @db.Decimal(8, 2)  // 前日比変化率（%）
  analysis    String   @db.Text           // AI原因分析
  relatedNews Json?                       // 関連ニュース [{title, url, sentiment}]
  createdAt   DateTime @default(now())

  @@unique([date, type, position])
  @@index([date(sort: Desc)])
  @@index([stockId])
  @@index([date, type])
}

// ========================================
// 通知機能
// ========================================

// アプリ内通知（履歴管理）
model Notification {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 通知タイプ: "ideal_entry_price" | "surge" | "plunge" | "sell_target"
  type        String

  // 関連銘柄
  stockId     String?
  stock       Stock?   @relation(fields: [stockId], references: [id], onDelete: SetNull)

  // 通知内容
  title       String
  body        String   @db.Text
  url         String?  // 遷移先URL

  // 価格情報（通知時点の情報を保存）
  triggerPrice    Decimal? @db.Decimal(12, 2)  // トリガーとなった価格
  targetPrice     Decimal? @db.Decimal(12, 2)  // 目標価格（理想買値/指値）
  changeRate      Decimal? @db.Decimal(8, 2)   // 変化率（急騰/急落用）

  // 状態管理
  isRead      Boolean  @default(false)
  isPushSent  Boolean  @default(false)  // プッシュ通知送信済みか

  createdAt   DateTime @default(now())
  readAt      DateTime?

  @@index([userId, isRead])
  @@index([userId, createdAt(sort: Desc)])
  @@index([stockId])
}

// ========================================
// 資産スナップショット
// ========================================

// 推薦結果追跡（精度検証用）
model RecommendationOutcome {
  id                    String   @id @default(cuid())

  // 推薦の種類と参照
  type                  String   // "daily" | "purchase" | "analysis"
  recommendationId      String   // 元の推薦レコードのID

  // 銘柄情報（分析用に非正規化して保持）
  stockId               String
  stock                 Stock    @relation(fields: [stockId], references: [id], onDelete: Cascade)
  tickerCode            String
  sector                String?

  // 推薦時点のスナップショット（後から変わる値を固定）
  recommendedAt         DateTime
  priceAtRec            Decimal  @db.Decimal(12, 2)
  prediction            String   // "buy" | "stay" | "remove" | "up" | "down" | "neutral"
  confidence            Decimal? @db.Decimal(5, 2)
  volatility            Decimal? @db.Decimal(8, 2)
  marketCap             BigInt?
  sectorTrendScore      Float?   // 推薦時点のセクタートレンド総合スコア
  sectorTrendDirection  String?  // 推薦時点のトレンド方向: "up"|"down"|"neutral"

  // 時間経過ごとのリターン（%）- バッチで段階的に埋まる
  returnAfter1Day       Decimal? @db.Decimal(8, 2)
  returnAfter3Days      Decimal? @db.Decimal(8, 2)
  returnAfter7Days      Decimal? @db.Decimal(8, 2)
  returnAfter14Days     Decimal? @db.Decimal(8, 2)

  // ベンチマーク（同期間の日経225リターン）
  benchmarkReturn7Days  Decimal? @db.Decimal(8, 2)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([type, recommendationId])
  @@index([type, recommendedAt])
  @@index([sector])
  @@index([tickerCode])
}

// ポートフォリオスナップショット（日次記録）
model PortfolioSnapshot {
  id                    String   @id @default(cuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date                  DateTime @db.Date

  // 資産サマリー
  totalValue            Decimal  @db.Decimal(15, 2)  // 総資産額（時価評価額）
  totalCost             Decimal  @db.Decimal(15, 2)  // 総投資額（取得原価）
  unrealizedGain        Decimal  @db.Decimal(15, 2)  // 含み損益
  unrealizedGainPercent Decimal  @db.Decimal(8, 2)   // 損益率（%）

  // 銘柄数
  stockCount            Int                          // 保有銘柄数

  // セクター別内訳（JSON）
  sectorBreakdown       Json?    // [{sector: "情報・通信", value: 150000, percent: 30.5}, ...]

  // 銘柄別内訳（JSON）
  stockBreakdown        Json?    // [{stockId: "xxx", name: "トヨタ", value: 50000, percent: 10.2}, ...]

  createdAt             DateTime @default(now())

  @@unique([userId, date])
  @@index([userId, date(sort: Desc)])
}
