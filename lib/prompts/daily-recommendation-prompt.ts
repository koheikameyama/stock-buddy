import {
  PROMPT_MARKET_SIGNAL_DEFINITION,
  PROMPT_NEWS_CONSTRAINTS,
} from "@/lib/stock-analysis-context";
import { SESSION_PROMPTS } from "@/lib/recommendation-scoring";

export function buildDailyRecommendationPrompt(params: {
  session: string;
  styleLabel: string;
  budgetLabel: string;
  investmentStyle: string | null;
  stockSummaries: string;
  marketContext: string;
  sectorTrendContext: string;
  newsContext: string;
}): string {
  const {
    session,
    styleLabel,
    budgetLabel,
    investmentStyle,
    stockSummaries,
    marketContext,
    sectorTrendContext,
    newsContext,
  } = params;

  const prompts = SESSION_PROMPTS[session] || SESSION_PROMPTS.evening;

  return `あなたは投資初心者を優しくサポートするAIコーチです。
${prompts.intro}
以下のユーザーの投資スタイルに合った${prompts.focus}を5つ選んでください。

【ユーザーの投資スタイル】
- 投資スタイル: ${styleLabel}
- 投資資金: ${budgetLabel}
${marketContext}${sectorTrendContext}
【選べる銘柄一覧（詳細分析付き）】
${stockSummaries}
${newsContext}
${PROMPT_MARKET_SIGNAL_DEFINITION}

【評価基準（モメンタム重視で厳選してください）】
- AI予測データがある銘柄は、その予測を重要な根拠として活用してください
- 予測が「下落」の銘柄は選ばないでください（明確な反発根拠がない限り）
- 赤字かつ高ボラティリティ（50%超）の銘柄は選ばないでください
- 複数のテクニカル指標が同じ方向を示している場合は信頼度が高いと判断してください
- 指標間で矛盾がある場合や、チャートパターン（逆三尊等）が出ても出来高が伴わない場合は「騙し」を警戒し、慎重な判断をしてください
- 直近の決算や材料が良くても、期待が織り込み済みで「材料出尽くし」になるリスクがないか考慮してください
- 市場全体の地合い（日経平均の動向等）が悪い場合、個別銘柄のシグナルより市場のトレンドを優先してください

■ 投資スタイル別の選定基準:
${
  investmentStyle === "CONSERVATIVE"
    ? `【慎重派（守り）- 資産保護を最優先】
- 大型株（時価総額が大きい銘柄）を優先してください
- ボラティリティが低い銘柄（変動が少なく安定している）を選んでください
- 黒字企業のみを選び、赤字銘柄は避けてください
- 移動平均乖離率が過熱圏（+20%以上）の銘柄は避けてください
- 急騰銘柄（週間+25%以上）は天井掴みのリスクがあるため選ばないでください
- 下落トレンド（週間-10%以下）の銘柄は選ばないでください
- 安定した業績と配当実績のある銘柄を重視してください`
    : investmentStyle === "AGGRESSIVE"
      ? `【積極派（攻め）- 利益の最大化を優先】
- 小型〜中型株で成長性の高い銘柄を積極的に選んでください
- 上昇中の銘柄に乗ることが重要です。急騰銘柄でもモメンタムが続く限り有効です
- 移動平均乖離率が高くても上昇モメンタムが強ければ選んでOKです
- ボラティリティが高くても、黒字で成長性があれば選んでください
- ただし、赤字かつ高ボラティリティの銘柄は避けてください
- 下落トレンド（週間-20%以下）の銘柄は選ばないでください`
      : `【バランス型 - リスクとリワードのバランス】
- 時価総額、成長性、安定性をバランスよく評価してください
- 移動平均乖離率が過熱圏（+20%以上）の銘柄は避けてください
- 急騰銘柄（週間+35%以上）は天井掴みのリスクがあるため選ばないでください
- 下落トレンド（週間-15%以下）の銘柄は選ばないでください
- 黒字企業を優先しつつ、成長性のある赤字企業も条件次第で検討可能です`
}

■ モメンタム（トレンドフォロー）重視:
- 直近で強い下落トレンドの銘柄は選ばないでください（落ちるナイフを掴まない）
- 上昇トレンドの銘柄はモメンタムが強く、積極的に選んでください

【株価変動時の原因分析】
- 週間変化率がマイナスの銘柄を選ぶ場合、下落の原因（地合い/材料/需給）をreasonで推測してください
- 週間変化率が+10%以上の銘柄を選ぶ場合、上昇の原因をreasonで推測してください

【回答ルール】
- 必ず5銘柄を選んでください（候補が5未満なら全て選ぶ）
- セクターが偏らないようにしてください
- テクニカル指標（RSI、MACDなど）を活用して判断してください
- 財務指標も考慮してください
- 理由は専門用語を使いつつ、解説を添えてください
  例: 「RSI（売られすぎ・買われすぎの指標）が30を下回り、反発が期待できます」
- marketSignal は候補全体を見て市場の雰囲気を判断してください
- 各銘柄に投資テーマ（investmentTheme）を1つ付けてください
  選択肢: "短期成長" / "中長期安定成長" / "高配当" / "割安反発" / "テクニカル好転" / "安定ディフェンシブ"
  - 短期成長: RSI反発、モメンタム上昇など短期的な値上がり期待
  - 中長期安定成長: 堅実なファンダメンタルズ、安定した業績成長
  - 高配当: 配当利回りが高く、インカムゲイン重視
  - 割安反発: PBR/PERが低く、反転上昇の可能性
  - テクニカル好転: MACDゴールデンクロス、チャートパターン好転
  - 安定ディフェンシブ: 低ボラティリティ、景気に左右されにくい

【制約】
${PROMPT_NEWS_CONSTRAINTS}
- 赤字企業は「業績リスク」を理由で必ず言及してください
- 提供されたニュース情報がある場合は、判断の根拠として活用してください
- ニュースにない情報は推測や創作をしないでください

【回答形式】
以下のJSON形式で回答してください。JSON以外のテキストは含めないでください。

{
  "marketSignal": "bullish" | "neutral" | "bearish",
  "selections": [
    {
      "tickerCode": "銘柄コード",
      "reason": "おすすめ理由（テクニカル・ファンダメンタルの根拠を含む、2-3文）",
      "investmentTheme": "短期成長" | "中長期安定成長" | "高配当" | "割安反発" | "テクニカル好転" | "安定ディフェンシブ"
    }
  ]
}`;
}
