name: Daily Report Generation

on:
  schedule:
    # 毎日 JST 09:00 (UTC 00:00) に実行
    - cron: '0 0 * * *'
  workflow_dispatch: # 手動実行も可能

jobs:
  generate-reports:
    runs-on: ubuntu-latest

    steps:
      - name: Generate daily reports
        id: generate
        run: |
          RESPONSE=$(curl -X POST https://stock-buddy.net/api/reports/generate-all \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -w "\nHTTP_CODE:%{http_code}" \
            -s)

          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | grep -v "HTTP_CODE")

          echo "response=$BODY" >> $GITHUB_OUTPUT
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Error: HTTP $HTTP_CODE"
            exit 1
          fi

      - name: Send push notifications
        if: success()
        run: |
          curl -X POST "${{ secrets.APP_URL }}/api/push/send" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -d '{"title":"今日の振り返りレポートが準備できました","body":"ポートフォリオの状況を確認しましょう","url":"/dashboard/reports"}' \
            -s

      - name: Notify Slack on success
        if: success()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_TITLE: "✅ Daily Report Generation Succeeded"
          SLACK_MESSAGE: ${{ steps.generate.outputs.response }}
          SLACK_COLOR: good
          SLACK_FOOTER: "Stock Buddy"

      - name: Notify Slack on failure
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_TITLE: "❌ Daily Report Generation Failed"
          SLACK_MESSAGE: |
            HTTP Code: ${{ steps.generate.outputs.http_code }}
            Response: ${{ steps.generate.outputs.response }}
          SLACK_COLOR: danger
          SLACK_FOOTER: "Stock Buddy"
