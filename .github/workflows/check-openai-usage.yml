name: Check OpenAI API Usage

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ 10:00 JST (01:00 UTC)
    - cron: '0 1 * * 1'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  check-usage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Check OpenAI API usage
        env:
          OPENAI_ADMIN_KEY: ${{ secrets.OPENAI_ADMIN_KEY }}
        run: |
          python scripts/github-actions/check_openai_usage.py

      - name: Create Issue on High Usage
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = 'ğŸš¨ OpenAI APIäºˆç®—ã‚¢ãƒ©ãƒ¼ãƒˆ';
            const body = `
            ## OpenAI APIä½¿ç”¨é‡ãŒäºˆç®—ã‚’è¶…éã—ã¾ã—ãŸ

            **æ—¥æ™‚**: ${new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}

            ### å¯¾å¿œãŒå¿…è¦ã§ã™

            1. [OpenAI Usage Dashboard](https://platform.openai.com/usage)ã§è©³ç´°ã‚’ç¢ºèª
            2. AIåˆ†æé »åº¦ã®èª¿æ•´ã‚’æ¤œè¨
            3. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æœ€é©åŒ–ã‚’æ¤œè¨

            ### é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

            - [OpenAI APIãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°æ‰‹é †](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/openai-api-monitoring.md)
            - [ã‚³ã‚¹ãƒˆåˆ†æ](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/cost-analysis.md)

            ### è‡ªå‹•ç”Ÿæˆ

            ã“ã®Issueã¯GitHub Actionsã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
            `;

            // æ—¢å­˜ã®IssueãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'alert,openai-usage',
            });

            // æ—¢å­˜ã®IssueãŒãªã‘ã‚Œã°æ–°è¦ä½œæˆ
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['alert', 'openai-usage', 'urgent'],
              });
              console.log('âœ… Issue created');
            } else {
              console.log('â„¹ï¸  Alert issue already exists');
            }
